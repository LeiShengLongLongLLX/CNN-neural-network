# RISC-Væ±‡ç¼–è¯­è¨€
## ä¸€ã€æ€»æ¦‚

### 1.1 RISC-V æ±‡ç¼–è¯­è¨€æ¦‚è¿°

RISC-V æ±‡ç¼–è¯­è¨€æ˜¯ RISC-V æŒ‡ä»¤é›†æ¶æ„ï¼ˆISAï¼‰çš„ç›´æ¥äººæœºè¡¨ç¤ºå½¢å¼ï¼Œå®ƒç”¨äºç¼–å†™å¯è¢«æ±‡ç¼–å™¨ï¼ˆAssemblerï¼‰è½¬æ¢ä¸ºæœºå™¨ç çš„ç¨‹åºã€‚
å®ƒä¸»è¦é¢å‘ **è£¸æœºï¼ˆBare-metalï¼‰ç¨‹åºã€æ“ä½œç³»ç»Ÿå†…æ ¸å’Œåº•å±‚é©±åŠ¨å¼€å‘**ã€‚

RISC-V çš„æ±‡ç¼–è¯­è¨€å…·æœ‰ï¼š

* **ç®€æ´ç»Ÿä¸€çš„æŒ‡ä»¤æ ¼å¼**
* **æ¨¡å—åŒ–çš„æ‰©å±•æœºåˆ¶**ï¼ˆå¦‚ I/M/F/D/A/C/V ç­‰ï¼‰
* **å¯„å­˜å™¨æ•°é‡å›ºå®šï¼ˆ32 ä¸ªæ•´æ•°å¯„å­˜å™¨ï¼‰**
* **å°‘é‡æŒ‡ä»¤ç±»å‹ï¼ˆR/I/S/B/U/Jï¼‰**
* **ç¬¦å·å‹å¥½**ï¼Œé€‚åˆæ•™å­¦å’ŒåµŒå…¥å¼å¼€å‘

---

### 1.2 å¯„å­˜å™¨ä½“ç³»

RISC-V ä¸­æœ‰ **32 ä¸ªé€šç”¨å¯„å­˜å™¨ï¼ˆx0â€“x31ï¼‰**ï¼Œæ¯ä¸ªå¯„å­˜å™¨éƒ½æœ‰ä¸€ä¸ªåˆ«åï¼š

| åç§°               | ç¼–å·    | çº¦å®šç”¨é€”        |
| ---------------- | ----- | ----------- |
| x0 (zero)        | 0     | æ’ä¸º 0        |
| x1 (ra)          | 1     | è¿”å›åœ°å€        |
| x2 (sp)          | 2     | æ ˆæŒ‡é’ˆ         |
| x3 (gp)          | 3     | å…¨å±€æŒ‡é’ˆ        |
| x4 (tp)          | 4     | çº¿ç¨‹æŒ‡é’ˆ        |
| x5â€“x7 (t0â€“t2)    | 5â€“7   | ä¸´æ—¶å¯„å­˜å™¨       |
| x8 (s0/fp)       | 8     | ä¿å­˜å¯„å­˜å™¨ / å¸§æŒ‡é’ˆ |
| x9 (s1)          | 9     | ä¿å­˜å¯„å­˜å™¨       |
| x10â€“x11 (a0â€“a1)  | 10â€“11 | å‡½æ•°å‚æ•°/è¿”å›å€¼    |
| x12â€“x17 (a2â€“a7)  | 12â€“17 | å‡½æ•°å‚æ•°        |
| x18â€“x27 (s2â€“s11) | 18â€“27 | ä¿å­˜å¯„å­˜å™¨       |
| x28â€“x31 (t3â€“t6)  | 28â€“31 | ä¸´æ—¶å¯„å­˜å™¨       |

---

### 1.3 æ±‡ç¼–æŒ‡ä»¤çš„å…­ç§åŸºæœ¬æ ¼å¼

| æ ¼å¼     | ç¤ºä¾‹                  | è¯´æ˜          |
| ------ | ------------------- | ----------- |
| R-type | `add x1, x2, x3`    | ä¸‰ä¸ªå¯„å­˜å™¨æ“ä½œæ•°    |
| I-type | `addi x1, x2, 10`   | ç«‹å³æ•°æ“ä½œ       |
| S-type | `sw x1, 0(x2)`      | å­˜å‚¨åˆ°å†…å­˜       |
| B-type | `beq x1, x2, label` | æ¡ä»¶åˆ†æ”¯        |
| U-type | `lui x1, 0x12345`   | é«˜ 20 ä½ç«‹å³æ•°è£…è½½ |
| J-type | `jal x1, label`     | è·³è½¬å¹¶ä¿å­˜è¿”å›åœ°å€   |

---

### 1.4 ä¸»è¦æŒ‡ä»¤ç±»åˆ«

#### 1ï¸âƒ£ ç®—æœ¯ä¸é€»è¾‘æŒ‡ä»¤

```asm
add x3, x1, x2     # x3 = x1 + x2
sub x3, x1, x2     # x3 = x1 - x2
and x3, x1, x2     # æŒ‰ä½ä¸
or  x3, x1, x2     # æŒ‰ä½æˆ–
xor x3, x1, x2     # æŒ‰ä½å¼‚æˆ–
sll x3, x1, x2     # å·¦ç§»
srl x3, x1, x2     # é€»è¾‘å³ç§»
sra x3, x1, x2     # ç®—æœ¯å³ç§»
```

#### 2ï¸âƒ£ ç«‹å³æ•°æŒ‡ä»¤

```asm
addi x3, x1, 10    # x3 = x1 + 10
andi x3, x1, 0xF
ori  x3, x1, 0xF
```

#### 3ï¸âƒ£ å†…å­˜è®¿é—®ï¼ˆLoad/Storeï¼‰

```asm
lw  x3, 0(x1)      # ä»å†…å­˜åŠ è½½å­—
sw  x3, 0(x1)      # å°†å­—å†™å…¥å†…å­˜
lb  x3, 0(x1)      # åŠ è½½å­—èŠ‚ï¼ˆå¸¦ç¬¦å·æ‰©å±•ï¼‰
lbu x3, 0(x1)      # åŠ è½½å­—èŠ‚ï¼ˆæ— ç¬¦å·æ‰©å±•ï¼‰
```

#### 4ï¸âƒ£ åˆ†æ”¯ä¸è·³è½¬

```asm
beq  x1, x2, label # ç›¸ç­‰åˆ™è·³è½¬
bne  x1, x2, label # ä¸ç­‰åˆ™è·³è½¬
blt  x1, x2, label # å°äºè·³è½¬
bge  x1, x2, label # å¤§äºç­‰äºè·³è½¬
jal  x1, label     # è·³è½¬å¹¶ä¿å­˜è¿”å›åœ°å€
jalr x1, 0(x2)     # é—´æ¥è·³è½¬
```

#### 5ï¸âƒ£ ç³»ç»ŸæŒ‡ä»¤

```asm
ecall              # ç¯å¢ƒè°ƒç”¨ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰
ebreak             # è°ƒè¯•æ–­ç‚¹
csrrw x1, mstatus, x2  # è¯»å†™ CSR
```

---

### 1.5 å‡½æ•°è°ƒç”¨è§„èŒƒï¼ˆCalling Conventionï¼‰

RISC-V è°ƒç”¨è§„èŒƒè§„å®šäº†å‚æ•°å’Œè¿”å›å€¼åœ¨å¯„å­˜å™¨ä¸­çš„ä¼ é€’æ–¹å¼ï¼š

* **å‚æ•°å¯„å­˜å™¨**ï¼š`a0â€“a7`ï¼ˆx10â€“x17ï¼‰
* **è¿”å›å€¼å¯„å­˜å™¨**ï¼š`a0â€“a1`
* **ä¿å­˜å¯„å­˜å™¨**ï¼š`s0â€“s11` å¿…é¡»åœ¨è°ƒç”¨é—´ä¿æŒä¸å˜
* **è¿”å›åœ°å€å¯„å­˜å™¨**ï¼š`ra`ï¼ˆx1ï¼‰
* **æ ˆæŒ‡é’ˆ**ï¼š`sp`ï¼ˆx2ï¼‰

è°ƒç”¨å‡½æ•°ä¾‹ï¼š

```asm
# è°ƒç”¨å‡½æ•°
jal ra, func

# å‡½æ•°è¿”å›
ret     # ç­‰ä»·äº jalr x0, 0(ra)
```

---

### 1.6 ä¼ªæŒ‡ä»¤ï¼ˆAssembler Pseudo Instructionsï¼‰

ä¼ªæŒ‡ä»¤ç”±æ±‡ç¼–å™¨è‡ªåŠ¨å±•å¼€ä¸ºå®é™…æœºå™¨æŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼š

| ä¼ªæŒ‡ä»¤          | å±•å¼€å½¢å¼             |
| ------------ | ---------------- |
| `mv x1, x2`  | `addi x1, x2, 0` |
| `nop`        | `addi x0, x0, 0` |
| `li x1, 100` | `addi/lui` ç»„åˆ    |
| `la x1, var` | åœ°å€åŠ è½½ï¼ˆPC ç›¸å¯¹ï¼‰      |

---

### 1.7 ä¾‹ç¨‹ï¼šç®€å•åŠ æ³•ç¨‹åº

```asm
.section .text
.globl _start

_start:
    li   x5, 10       # x5 = 10
    li   x6, 20       # x6 = 20
    add  x7, x5, x6   # x7 = x5 + x6
    ecall             # è°ƒç”¨ç³»ç»ŸæœåŠ¡ï¼ˆå¦‚é€€å‡ºï¼‰
```

---

### 1.8 æ±‡ç¼–å·¥å…·é“¾

åœ¨ Linux ä¸‹ï¼ˆå¦‚ Ubuntu 20.04ï¼‰å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£… RISC-V æ±‡ç¼–å¼€å‘ç¯å¢ƒï¼š

```bash
sudo apt install gcc-riscv64-unknown-elf gdb-multiarch qemu-system-misc
```

å¸¸è§å‘½ä»¤ï¼š

| å‘½ä»¤                               | åŠŸèƒ½     |
| -------------------------------- | ------ |
| `riscv64-unknown-elf-as`         | æ±‡ç¼–å™¨    |
| `riscv64-unknown-elf-ld`         | é“¾æ¥å™¨    |
| `riscv64-unknown-elf-objdump -d` | åæ±‡ç¼–    |
| `qemu-system-riscv64`            | æ¨¡æ‹Ÿè¿è¡Œ   |
| `gdb-multiarch`                  | è°ƒè¯•æ±‡ç¼–ç¨‹åº |

---

### 1.9 ç‰¹æƒæ±‡ç¼–æŒ‡ä»¤ï¼ˆæ¥è‡ªã€ŠRISC-V ç‰¹æƒæ¶æ„æ‰‹å†Œã€‹ï¼‰

ç‰¹æƒçº§ç¨‹åºå¯è®¿é—® **CSRï¼ˆæ§åˆ¶ä¸çŠ¶æ€å¯„å­˜å™¨ï¼‰** å¹¶ä½¿ç”¨å¦‚ä¸‹æŒ‡ä»¤ï¼š

| æŒ‡ä»¤                   | åŠŸèƒ½         |
| -------------------- | ---------- |
| `csrrw rd, csr, rs1` | è¯» CSR å¹¶å†™æ–°å€¼ |
| `csrrs rd, csr, rs1` | è¯» CSR å¹¶ç½®ä½  |
| `mret`               | ä» M æ¨¡å¼è¿”å›   |
| `sret`               | ä» S æ¨¡å¼è¿”å›   |
| `wfi`                | ç­‰å¾…ä¸­æ–­       |

---

### 1.10 æ€»ç»“

RISC-V æ±‡ç¼–è¯­è¨€ç‰¹ç‚¹æ€»ç»“ï¼š

* æŒ‡ä»¤æ ¼å¼ç»Ÿä¸€ã€æ˜“äºè§£æï¼›
* å¯„å­˜å™¨å‘½åä½“ç³»æ¸…æ™°ï¼›
* æ¨¡å—åŒ–æ‰©å±•è®¾è®¡ï¼›
* ä¼ªæŒ‡ä»¤å‹å¥½ï¼Œç¼–å†™ç®€ä¾¿ï¼›
* æ—¢èƒ½ç”¨äºè£¸æœºï¼Œä¹Ÿå¯æ”¯æ’‘æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚

---

## äºŒã€æŒ‡ä»¤æ ¼å¼ä¸è¯­æ³•

> RISC-V æ±‡ç¼–è¯­å¥çš„åŸºæœ¬ç»“æ„ï¼š

```
[label:]   [operation]   [comment]
```

ä¸‹é¢æˆ‘**è¯¦ç»†è§£é‡Šæ¯ä¸ªéƒ¨åˆ†çš„å«ä¹‰ã€ç”¨æ³•å’Œè§„åˆ™**

---

### 2.1 RISC-V æ±‡ç¼–è¯­å¥çš„ä¸‰å¤§ç»„æˆéƒ¨åˆ†

ä¸€æ¡å…¸å‹çš„ RISC-V æ±‡ç¼–è¯­å¥ç”±ä»¥ä¸‹ **ä¸‰éƒ¨åˆ†** æ„æˆï¼š

| éƒ¨åˆ†                  | è¯´æ˜                                  | æ˜¯å¦å¿…é¡» | ç¤ºä¾‹                |
| ------------------- | ----------------------------------- | ---- | ----------------- |
| **labelï¼ˆæ ‡ç­¾ï¼‰**       | ç¨‹åºä¸­çš„æ ‡è¯†ç¬¦ï¼Œç”¨æ¥æ ‡è®°æŒ‡ä»¤æˆ–æ•°æ®çš„åœ°å€ã€‚å¸¸ç”¨äºè·³è½¬ã€åˆ†æ”¯æˆ–æ•°æ®å¼•ç”¨ã€‚ | å¯é€‰   | `loop:`ã€`_start:` |
| **operationï¼ˆæ“ä½œéƒ¨åˆ†ï¼‰** | åŒ…æ‹¬â€œåŠ©è®°ç¬¦ + æ“ä½œæ•°â€ï¼Œæ˜¯çœŸæ­£çš„æ±‡ç¼–æŒ‡ä»¤æˆ–ä¼ªæŒ‡ä»¤ã€‚         | å¿…é¡»   | `add x5, x6, x7`  |
| **commentï¼ˆæ³¨é‡Šï¼‰**     | å¯¹æœ¬è¡Œä»£ç çš„è§£é‡Šæˆ–è¯´æ˜ï¼Œä»¥ `#` æˆ– `//` å¼€å¤´ã€‚        | å¯é€‰   | `# å°†x6å’Œx7ç›¸åŠ å­˜å…¥x5`  |


- **æ ¼å¼ä¸¾ä¾‹**

```asm
loop:           addi x5, x5, -1     # è®¡æ•°å™¨å‡ 1
                bnez x5, loop       # å¦‚æœä¸ä¸º 0ï¼Œè·³å› loop
```

é€é¡¹è§£æï¼š

1. `loop:` â€”â€” æ ‡ç­¾ï¼ˆä»£è¡¨æ­¤è¡Œçš„åœ°å€ï¼Œå¯è¢« `bnez` è·³è½¬æŒ‡ä»¤å¼•ç”¨ï¼‰ã€‚
2. `addi x5, x5, -1` â€”â€” æ“ä½œéƒ¨åˆ†ï¼šåŠ©è®°ç¬¦ `addi` è¡¨ç¤ºâ€œåŠ ç«‹å³æ•°â€ï¼Œæ“ä½œæ•°ä¸º `x5, x5, -1`ã€‚
3. `# è®¡æ•°å™¨å‡ 1` â€”â€” æ³¨é‡Šï¼Œç”¨äºè§£é‡ŠæŒ‡ä»¤ä½œç”¨ã€‚

---

### 2.2 æ“ä½œéƒ¨åˆ†çš„ç»“æ„

æ“ä½œéƒ¨åˆ†é€šå¸¸åˆ†ä¸ºå››ç±»ï¼š

#### 1. æŒ‡ä»¤ï¼ˆInstructionï¼‰

**ï¼ˆ1ï¼‰å®šä¹‰ï¼š**
æŒ‡ä»¤æ˜¯ç”± CPU ç›´æ¥è¯†åˆ«å’Œæ‰§è¡Œçš„å‘½ä»¤ï¼Œå¯¹åº”ç€çœŸå®çš„æœºå™¨ç ï¼ˆmachine codeï¼‰ã€‚
RISC-V çš„æ‰€æœ‰åŸºç¡€æŒ‡ä»¤å‡ä¸ºå®šé•¿ 32 ä½ï¼Œå±äº **Rã€Iã€Sã€Bã€Uã€J** å…­ç§æ ¼å¼ä¹‹ä¸€ã€‚

**ï¼ˆ2ï¼‰ä½œç”¨ï¼š**
æ‰§è¡Œå®é™…çš„è¿ç®—ã€è·³è½¬ã€æ•°æ®è¯»å†™ç­‰åŠŸèƒ½ï¼Œæ˜¯ç¨‹åºçš„â€œå¯æ‰§è¡Œéƒ¨åˆ†â€ã€‚

**ï¼ˆ3ï¼‰ç‰¹ç‚¹ï¼š**

> * ç”±ç¡¬ä»¶ç›´æ¥æ‰§è¡Œï¼›
> * æ±‡ç¼–å™¨ä¼šæŠŠå®ƒä»¬è½¬æ¢æˆäºŒè¿›åˆ¶æœºå™¨æŒ‡ä»¤ï¼›
> * æ“ä½œå¯¹è±¡æ˜¯å¯„å­˜å™¨ã€ç«‹å³æ•°æˆ–å†…å­˜åœ°å€ï¼›
> * éµå¾ª RISC-V ISAï¼ˆæŒ‡ä»¤é›†æ¶æ„ï¼‰å®šä¹‰ã€‚

**ï¼ˆ4ï¼‰å¸¸è§ç¤ºä¾‹ï¼š**

```asm
add  x5, x6, x7       # å¯„å­˜å™¨ç›¸åŠ ï¼ˆR-typeï¼‰
addi x5, x6, 10       # åŠ ç«‹å³æ•°ï¼ˆI-typeï¼‰
lw   x5, 0(x6)        # ä»å†…å­˜åŠ è½½ï¼ˆI-typeï¼‰
sw   x5, 0(x6)        # å†™å…¥å†…å­˜ï¼ˆS-typeï¼‰
beq  x5, x6, loop     # æ¡ä»¶è·³è½¬ï¼ˆB-typeï¼‰
jal  x1, func         # è·³è½¬å¹¶ä¿å­˜è¿”å›åœ°å€ï¼ˆJ-typeï¼‰
ecall                 # ç³»ç»Ÿè°ƒç”¨
```

---

#### 2. ä¼ªæŒ‡ä»¤ï¼ˆPseudo Instructionï¼‰

**ï¼ˆ1ï¼‰å®šä¹‰ï¼š**
ä¼ªæŒ‡ä»¤æ˜¯ **æ±‡ç¼–å™¨æä¾›çš„ç®€åŒ–å†™æ³•**ï¼Œæœ¬èº«ä¸æ˜¯ CPU æŒ‡ä»¤ï¼Œ
æ±‡ç¼–æ—¶ç”±æ±‡ç¼–å™¨è‡ªåŠ¨è½¬æ¢ä¸ºä¸€æ¡æˆ–å¤šæ¡çœŸå®æœºå™¨æŒ‡ä»¤ï¼ˆInstructionï¼‰ã€‚

**ï¼ˆ2ï¼‰ä½œç”¨ï¼š**
è®©ç¨‹åºå‘˜æ›´æ–¹ä¾¿åœ°ç¼–å†™ä»£ç ï¼Œé¿å…æ‰‹åŠ¨å†™å‡ºå¤æ‚çš„ç»„åˆæŒ‡ä»¤ã€‚

**ï¼ˆ3ï¼‰ç‰¹ç‚¹ï¼š**

> * ä¸å¯¹åº”å•ä¸€æœºå™¨ç ï¼›
> * ç”±æ±‡ç¼–å™¨è‡ªåŠ¨å±•å¼€ï¼›
> * å¸¸ç”¨äºç«‹å³æ•°åŠ è½½ã€å¯„å­˜å™¨èµ‹å€¼ã€å‡½æ•°è¿”å›ç­‰å¸¸ç”¨æ“ä½œã€‚

**ï¼ˆ4ï¼‰å¸¸è§ç¤ºä¾‹ï¼š**

| ä¼ªæŒ‡ä»¤            | å¯¹åº”çœŸå®æŒ‡ä»¤å±•å¼€å½¢å¼                                        |
| -------------- | ------------------------------------------------- |
| `li x5, 1000`  | `lui x5, 0x1` + `addi x5, x5, 0xE8`               |
| `mv x6, x7`    | `addi x6, x7, 0`                                  |
| `nop`          | `addi x0, x0, 0`                                  |
| `not x5, x6`   | `xori x5, x6, -1`                                 |
| `la x5, label` | `auipc x5, imm[31:12]` + `addi x5, x5, imm[11:0]` |
| `ret`          | `jalr x0, 0(ra)`                                  |

**ï¼ˆ5ï¼‰è¯´æ˜ï¼š**
ä¼ªæŒ‡ä»¤åªæ˜¯æ±‡ç¼–å™¨å±‚é¢çš„â€œè¯­æ³•ç³–â€ï¼Œ
å¯¹ CPU æ¥è¯´ï¼Œå®ƒä»¬è¢«æ›¿æ¢ä¸ºæ™®é€šæŒ‡ä»¤åå†æ‰§è¡Œã€‚

---

#### 3. æŒ‡ç¤ºï¼ˆDirective / Assembler Directiveï¼‰

**ï¼ˆ1ï¼‰å®šä¹‰ï¼š**
æŒ‡ç¤ºï¼ˆåˆç§°â€œä¼ªæ“ä½œâ€ï¼‰æ˜¯ç»™æ±‡ç¼–å™¨ï¼ˆAssemblerï¼‰ä¸‹è¾¾çš„**æ§åˆ¶å‘½ä»¤**ï¼Œ
ç”¨äºæŒ‡å¯¼æ±‡ç¼–å™¨ç»„ç»‡ä»£ç ã€åˆ†é…å†…å­˜ã€å®šä¹‰æ•°æ®ã€å£°æ˜ç¬¦å·ç­‰ã€‚
ğŸ‘‰ å®ƒä»¬ä¸ä¼šè¢«ç¿»è¯‘ä¸ºæœºå™¨ç ã€‚

**ï¼ˆ2ï¼‰ä½œç”¨ï¼š**

* æ§åˆ¶ç¨‹åºçš„æ®µï¼ˆsectionï¼‰ç»“æ„ï¼›
* å®šä¹‰å¸¸é‡ã€å˜é‡ã€å­—ç¬¦ä¸²ï¼›
* å£°æ˜å…¨å±€ç¬¦å·ã€å¯¹é½ã€å†…å­˜å¸ƒå±€ç­‰ã€‚

**ï¼ˆ3ï¼‰ç‰¹ç‚¹ï¼š**

> * ä»¥ `.`ï¼ˆç‚¹å·ï¼‰å¼€å¤´ï¼›
> * ä¸è¢« CPU æ‰§è¡Œï¼Œåªè¢«æ±‡ç¼–å™¨è¯†åˆ«ï¼›
> * åœ¨æœ€ç»ˆæœºå™¨ä»£ç ä¸­ **ä¸å æŒ‡ä»¤ç©ºé—´**ã€‚

**ï¼ˆ4ï¼‰å¸¸è§æŒ‡ç¤ºåŠè¯´æ˜ï¼š**

| æŒ‡ç¤º                 | è¯´æ˜             |
| ------------------ | -------------- |
| `.text`            | æŒ‡å®šæ¥ä¸‹æ¥çš„å†…å®¹æ”¾åœ¨ä»£ç æ®µ  |
| `.data`            | æŒ‡å®šæ¥ä¸‹æ¥çš„å†…å®¹æ”¾åœ¨æ•°æ®æ®µ  |
| `.bss`             | å®šä¹‰æœªåˆå§‹åŒ–æ•°æ®æ®µ      |
| `.globl symbol`    | å£°æ˜å…¨å±€ç¬¦å·ï¼ˆé“¾æ¥æ—¶å¯è®¿é—®ï¼‰ |
| `.section name`    | è‡ªå®šä¹‰æ®µåç§°         |
| `.word value`      | å®šä¹‰ä¸€ä¸ª 32 ä½æ•´æ•°å¸¸é‡  |
| `.byte value`      | å®šä¹‰ä¸€ä¸ªå­—èŠ‚æ•°æ®       |
| `.string "..."`    | å®šä¹‰å­—ç¬¦ä¸²å¸¸é‡        |
| `.align n`         | æŒ‰ 2â¿ å­—èŠ‚å¯¹é½      |
| `.equ name, value` | å®šä¹‰ç¬¦å·å¸¸é‡         |

**ï¼ˆ5ï¼‰ç¤ºä¾‹ï¼š**

```asm
.data
num:    .word 100
msg:    .string "Hello RISC-V\n"

.text
.globl _start
_start:
    la   a0, msg
    li   a7, 64
    ecall
```

> ä¸Šè¿° `.data`, `.word`, `.string`, `.text`, `.globl` å‡ä¸º **directive**ï¼Œ
> å®ƒä»¬ä¸ä¼šç”Ÿæˆæœºå™¨æŒ‡ä»¤ï¼Œåªå½±å“æ±‡ç¼–å™¨çš„ç»„ç»‡æ–¹å¼ã€‚

---

#### 4. å®å®šä¹‰ï¼ˆMacroï¼‰

**ï¼ˆ1ï¼‰å®šä¹‰ï¼š**
å®ï¼ˆmacroï¼‰æ˜¯ä¸€ç§ **æ±‡ç¼–çº§çš„æ–‡æœ¬æ›¿æ¢æœºåˆ¶**ï¼Œ
å…è®¸ç¨‹åºå‘˜å®šä¹‰å¯é‡å¤ä½¿ç”¨çš„ä»£ç æ¨¡æ¿ï¼Œæé«˜ä»£ç å¤ç”¨æ€§å’Œå¯è¯»æ€§ã€‚

**ï¼ˆ2ï¼‰ä½œç”¨ï¼š**
é€šè¿‡å®å®šä¹‰ï¼Œå¯ä»¥å®ç°ç±»ä¼¼å‡½æ•°è°ƒç”¨çš„ç»“æ„ï¼Œ
å‡å°‘é‡å¤ä»£ç å¹¶æ”¯æŒå‚æ•°åŒ–ã€‚

**ï¼ˆ3ï¼‰ç‰¹ç‚¹ï¼š**

> * åœ¨æ±‡ç¼–é˜¶æ®µç”±æ±‡ç¼–å™¨è¿›è¡Œâ€œæ–‡æœ¬å±•å¼€â€ï¼›
> * ä¸ç”Ÿæˆæœºå™¨ç æœ¬èº«ï¼›
> * å¯å¸¦å‚æ•°ï¼›
> * ç±»ä¼¼ C è¯­è¨€çš„ `#define` æˆ–å†…è”å‡½æ•°ã€‚

**ï¼ˆ4ï¼‰å®šä¹‰ä¸ä½¿ç”¨æ ¼å¼ï¼š**

```asm
.macro å®å å‚æ•°1, å‚æ•°2, ...
    [æŒ‡ä»¤åºåˆ—ï¼Œå¯ä½¿ç”¨å‚æ•°]
.endm
```

**ï¼ˆ5ï¼‰ç¤ºä¾‹ï¼š**

```asm
.macro SAVE reg
    addi sp, sp, -4
    sw   \reg, 0(sp)
.endm

.macro RESTORE reg
    lw   \reg, 0(sp)
    addi sp, sp, 4
.endm

.text
.globl _start
_start:
    SAVE ra           # å±•å¼€ä¸ºä¸¤æ¡æŒ‡ä»¤
    call func
    RESTORE ra
    ecall
```

æ±‡ç¼–å±•å¼€åç›¸å½“äºï¼š

```asm
addi sp, sp, -4
sw   ra, 0(sp)
call func
lw   ra, 0(sp)
addi sp, sp, 4
ecall
```

---

#### 5. å°ç»“ï¼šå››ç±» operation çš„å¯¹æ¯”è¡¨

| ç±»å‹    | è‹±æ–‡å                | æ˜¯å¦ç”Ÿæˆæœºå™¨ç     | æ˜¯å¦è¢« CPU æ‰§è¡Œ | æ˜¯å¦èƒ½å¸¦å‚æ•° | å…¸å‹å¼€å¤´     | ç¤ºä¾‹                 |
| ----- | ------------------ | ---------- | ---------- | ------ | -------- | ------------------ |
| â‘  æŒ‡ä»¤  | Instruction        | âœ… æ˜¯        | âœ… æ˜¯        | âœ…      | æ—         | `add`, `lw`, `jal` |
| â‘¡ ä¼ªæŒ‡ä»¤ | Pseudo Instruction | âœ…ï¼ˆå±•å¼€åï¼‰     | âœ…ï¼ˆå±•å¼€åï¼‰     | âœ…      | æ—         | `li`, `mv`, `ret`  |
| â‘¢ æŒ‡ç¤º  | Directive          | âŒ å¦        | âŒ å¦        | éƒ¨åˆ†æ”¯æŒ   | `.`      | `.text`, `.word`   |
| â‘£ å®å®šä¹‰ | Macro              | âŒ å¦ï¼ˆå±•å¼€ä¸ºä»£ç ï¼‰ | âœ…ï¼ˆå±•å¼€åæ‰§è¡Œï¼‰   | âœ…      | `.macro` | `.macro SAVE ra`   |

---

### 2.3 æ ‡ç­¾ï¼ˆLabelï¼‰è¯¦ç»†è¯´æ˜

æ ‡ç­¾ç›¸å½“äºâ€œç¨‹åºä¸­çš„å‘½ååœ°å€â€ï¼Œç”¨äºï¼š

* **åˆ†æ”¯è·³è½¬**ï¼ˆå¦‚ `beq`, `bne`, `jal`ï¼‰
* **æ•°æ®å¯»å€**ï¼ˆå¦‚ `.word`, `.data` åŒºä¸­çš„å˜é‡ï¼‰

æ ‡ç­¾å‘½åè§„åˆ™ï¼š

* ä»¥å­—æ¯æˆ–ä¸‹åˆ’çº¿ `_` å¼€å¤´
* åå¯è·Ÿå­—æ¯ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿
* åŒºåˆ†å¤§å°å†™
* ä»¥å†’å· `:` ç»“å°¾

ç¤ºä¾‹ï¼š

```asm
.data
value:  .word 100       # å®šä¹‰å˜é‡æ ‡ç­¾

.text
_start:
    la  a0, value       # åŠ è½½å˜é‡åœ°å€
    lw  a1, 0(a0)       # å–å‡ºæ•°æ®
```

---

### 2.4 æ³¨é‡Šï¼ˆCommentï¼‰

æ³¨é‡Šåœ¨æ±‡ç¼–ä¸­éå¸¸é‡è¦ï¼Œç”¨äºè¯´æ˜ç¨‹åºé€»è¾‘ï¼Œä¾¿äºé˜…è¯»å’Œè°ƒè¯•ã€‚
RISC-V ä¸­ï¼š

* å•è¡Œæ³¨é‡Šä»¥ `#` æˆ– `//` å¼€å¤´ï¼›
* å³ä¾§æ³¨é‡Šæˆ–ç‹¬ç«‹æ³¨é‡Šéƒ½å¯ä»¥ä½¿ç”¨ï¼›
* æ±‡ç¼–å™¨ä¼šå¿½ç•¥æ³¨é‡Šå†…å®¹ã€‚

ç¤ºä¾‹ï¼š

```asm
# è¿™æ˜¯ç‹¬ç«‹æ³¨é‡Š
addi x1, x1, 5     # æŠŠå¯„å­˜å™¨x1åŠ 5
```

---

### 2.5 å®Œæ•´è¯­å¥ç¤ºä¾‹

```asm
.text
.globl _start       # å£°æ˜ç¨‹åºå…¥å£ç¬¦å·

_start:
    li   a0, 5      # æŠŠå¸¸æ•°5è£…å…¥a0
    li   a1, 3      # æŠŠå¸¸æ•°3è£…å…¥a1
    add  a2, a0, a1 # a2 = a0 + a1
    ecall           # ç³»ç»Ÿè°ƒç”¨é€€å‡º
```

ç»“æ„åˆ†æï¼š

* `label:` â†’ `_start:`
* `operation` â†’ `li`, `add`, `ecall` ç­‰æŒ‡ä»¤
* `comment` â†’ ç”¨ `#` å¼€å¤´çš„æ–‡å­—è¯´æ˜

---

### 2.6 æ‹“å±•ï¼šRISC-V æ±‡ç¼–ä¸­çš„æ®µï¼ˆsectionï¼‰

RISC-V æ±‡ç¼–æ–‡ä»¶é€šå¸¸ç”±å¤šä¸ª**æ®µï¼ˆsectionï¼‰**ç»„æˆï¼Œç”¨äºåŒºåˆ†ä»£ç å’Œæ•°æ®ï¼š

| æ®µå              | åŠŸèƒ½            |
| --------------- | ------------- |
| `.text`         | å­˜æ”¾ç¨‹åºä»£ç ï¼ˆæŒ‡ä»¤ï¼‰    |
| `.data`         | å­˜æ”¾å·²åˆå§‹åŒ–çš„å…¨å±€æ•°æ®   |
| `.bss`          | å­˜æ”¾æœªåˆå§‹åŒ–çš„å…¨å±€æ•°æ®   |
| `.rodata`       | å­˜æ”¾åªè¯»å¸¸é‡æ•°æ®      |
| `.globl symbol` | å£°æ˜å…¨å±€ç¬¦å·ï¼Œä½¿é“¾æ¥å™¨å¯è§ |

ç¤ºä¾‹ï¼š

```asm
.data
msg:  .string "Hello RISC-V\n"

.text
.globl _start
_start:
    la   a0, msg     # åŠ è½½å­—ç¬¦ä¸²åœ°å€
    li   a7, 64      # write ç³»ç»Ÿè°ƒç”¨
    ecall
```

---

### 2.7 æ€»ç»“ï¼š
ä¸€æ¡ RISC-V æ±‡ç¼–è¯­å¥çš„æ ¼å¼ä¸ºï¼š

```
[label:]   operation   [# comment]
```

* **label**ï¼šæ ‡è¯†åœ°å€ï¼Œç»“å°¾åŠ å†’å·ï¼›
* **operation**ï¼šæŒ‡ä»¤åŠ©è®°ç¬¦ + æ“ä½œæ•°ï¼›
* **comment**ï¼šä»¥ `#` æˆ– `//` å¼€å¤´çš„æ³¨é‡Šï¼›
* æ¯æ¡è¯­å¥å ä¸€è¡Œï¼Œé¡ºåºæ‰§è¡Œï¼›
* ç©ºè¡Œã€ç¼©è¿›ã€å¯¹é½ä»…ä¸ºé˜…è¯»æ–¹ä¾¿ã€‚

---

## ä¸‰ã€æ“ä½œå¯¹è±¡ï¼ˆOperandsï¼‰

RISC-V æ±‡ç¼–æŒ‡ä»¤çš„ **æ“ä½œå¯¹è±¡ï¼ˆoperandï¼‰** æ˜¯æŒ‡ä»¤æ‰§è¡Œæ—¶æ‰€æ“ä½œçš„æ•°æ®æ¥æºä¸å­˜å‚¨ç›®æ ‡ã€‚
åœ¨æ±‡ç¼–è¯­å¥ä¸­ï¼Œå®ƒä»¬å‡ºç°åœ¨æ“ä½œéƒ¨åˆ†ï¼ˆoperationï¼‰ä¹‹åï¼Œä¾‹å¦‚ï¼š

```asm
add x5, x6, x7   # æ“ä½œå¯¹è±¡ä¸ºå¯„å­˜å™¨ x5, x6, x7
lw  x5, 0(x6)    # æ“ä½œå¯¹è±¡ä¸ºå¯„å­˜å™¨ x5 ä¸å†…å­˜å•å…ƒ [x6 + 0]
```

RISC-V çš„æ“ä½œå¯¹è±¡ä¸»è¦åˆ†ä¸ºä¸‰ç±»ï¼š

1. **å¯„å­˜å™¨ï¼ˆRegisterï¼‰**
2. **å†…å­˜ï¼ˆMemoryï¼‰**
3. **ç«‹å³æ•°ï¼ˆImmediate Valueï¼‰**


---

### 3.1 å¯„å­˜å™¨ï¼ˆRegisterï¼‰

å¯„å­˜å™¨æ˜¯ CPU å†…éƒ¨ç”¨äºä¸´æ—¶ä¿å­˜æ•°æ®çš„é«˜é€Ÿå­˜å‚¨å•å…ƒï¼Œ
åœ¨ RISC-V ä¸­ï¼Œå‡ ä¹æ‰€æœ‰è¿ç®—ã€åŠ è½½ã€å­˜å‚¨æ“ä½œéƒ½ä»¥å¯„å­˜å™¨ä¸ºæ“ä½œå¯¹è±¡ã€‚

RISC-V æ¶æ„è§„å®šå…±æœ‰ **32 ä¸ªé€šç”¨å¯„å­˜å™¨ï¼ˆx0 ~ x31ï¼‰**ï¼Œ
ä»¥åŠä¸€ç³»åˆ— **ç³»ç»Ÿçº§å¯„å­˜å™¨ï¼ˆCSR, Control and Status Registerï¼‰**ã€‚

---

#### 1. é€šç”¨å¯„å­˜å™¨ï¼ˆGeneral Purpose Registers, GPRï¼‰

#### ï¼ˆ1ï¼‰æ¦‚è¿°

* æ¯ä¸ªå¯„å­˜å™¨å®½åº¦ä¸å¤„ç†å™¨ä½å®½ä¸€è‡´ï¼ˆRV32 â†’ 32 ä½ï¼ŒRV64 â†’ 64 ä½ï¼‰ã€‚
* å¯„å­˜å™¨åç§°æœ‰ä¸¤ç§å½¢å¼ï¼š

  * **æ•°å­—ç¼–å·**ï¼š`x0`~`x31`
  * **åˆ«åï¼ˆABI åç§°ï¼‰**ï¼š`zero`, `ra`, `sp`, `a0`, `t0`, `s0` ç­‰ï¼Œç”¨äºå‡½æ•°è°ƒç”¨çº¦å®šã€‚

#### ï¼ˆ2ï¼‰å¯„å­˜å™¨è¡¨

| æ•°å­—ç¼–å·      | ABIåç§°      |        ç”¨é€”è¯´æ˜ |
| ------- | ------- | --------------------------- |
| x0      | zero    | å¸¸æ•° 0ï¼Œè¯»æ’ä¸º 0ï¼Œå†™æ“ä½œæ— æ•ˆ        |      
| x1      | ra      | è¿”å›åœ°å€å¯„å­˜å™¨ï¼ˆReturn Addressï¼‰ |      
| x2      | sp      | æ ˆæŒ‡é’ˆï¼ˆStack Pointerï¼‰      |      
| x3      | gp      | å…¨å±€æŒ‡é’ˆï¼ˆGlobal Pointerï¼‰    |      
| x4      | tp      | çº¿ç¨‹æŒ‡é’ˆï¼ˆThread Pointerï¼‰    |      
| x5â€“x7   | t0â€“t2   | ä¸´æ—¶å¯„å­˜å™¨ï¼ˆè°ƒç”¨è€…ä¿å­˜ï¼‰         |      
| x8      | s0 / fp | ä¿å­˜å¯„å­˜å™¨ / å¸§æŒ‡é’ˆ             |      
| x9      | s1      | ä¿å­˜å¯„å­˜å™¨                   |      
| x10â€“x11 | a0â€“a1   | å‡½æ•°å‚æ•° / è¿”å›å€¼              |      
| x12â€“x17 | a2â€“a7   | å‡½æ•°å‚æ•°å¯„å­˜å™¨                 |      
| x18â€“x27 | s2â€“s11  | è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨               |      
| x28â€“x31 | t3â€“t6   | ä¸´æ—¶å¯„å­˜å™¨ï¼ˆè°ƒç”¨è€…ä¿å­˜ï¼‰          |      

#### ï¼ˆ3ï¼‰ä½¿ç”¨ç¤ºä¾‹

```asm
addi sp, sp, -16      # ä¿®æ”¹æ ˆæŒ‡é’ˆï¼ˆspï¼‰
sw   ra, 12(sp)       # å°†è¿”å›åœ°å€ä¿å­˜åˆ°æ ˆä¸Š
lw   a0, 0(sp)        # ä»æ ˆåŠ è½½å‚æ•°
add  t0, a0, a1       # ä¸´æ—¶å¯„å­˜å™¨è®¡ç®—ç»“æœ
```

> âœ… æ³¨æ„ï¼š`x0` æ°¸è¿œä¸ºå¸¸æ•° 0ï¼Œå¯ä»¥å®‰å…¨ç”¨äºæ¸…é›¶ã€æ¯”è¾ƒç­‰æ“ä½œï¼š

```asm
add x5, x0, x0    # ç­‰ä»·äº li x5, 0
```

---

#### 2. ç³»ç»Ÿçº§å¯„å­˜å™¨ï¼ˆSystem Registers / CSRï¼‰

ç³»ç»Ÿçº§å¯„å­˜å™¨ï¼ˆCSR, Control and Status Registerï¼‰
ç”¨äº **ç®¡ç† CPU ç‰¹æƒçŠ¶æ€ã€å¼‚å¸¸ã€ä¸­æ–­ã€è®¡æ—¶å™¨ã€æƒé™æ§åˆ¶ç­‰**ã€‚

#### ï¼ˆ1ï¼‰CSR åˆ†ç±»

| ç±»å‹                         | å‰ç¼€ | åŠŸèƒ½                                     |
| -------------------------- | -- | -------------------------------------- |
| **Machine-levelï¼ˆM æ¨¡å¼ï¼‰**    | m* | æœ€é«˜ç‰¹æƒçº§å¯„å­˜å™¨ï¼Œå¦‚ `mstatus`, `mepc`, `mcause` |
| **Supervisor-levelï¼ˆS æ¨¡å¼ï¼‰** | s* | æ“ä½œç³»ç»Ÿä½¿ç”¨çš„å¯„å­˜å™¨ï¼Œå¦‚ `sstatus`, `sepc`         |
| **User-levelï¼ˆU æ¨¡å¼ï¼‰**       | u* | ç”¨æˆ·æ€ä¸‹å¯è®¿é—®çš„å¯„å­˜å™¨ï¼ˆè¾ƒå°‘ï¼‰                        |

#### ï¼ˆ2ï¼‰å¸¸è§ CSR å¯„å­˜å™¨

| åç§°                  | è¯´æ˜                                |
| ------------------- | --------------------------------- |
| `mstatus`           | å…¨å±€çŠ¶æ€æ§åˆ¶ï¼ˆä¸­æ–­ã€ç‰¹æƒä½ï¼‰                    |
| `mie`               | ä¸­æ–­ä½¿èƒ½å¯„å­˜å™¨                           |
| `mtvec`             | å¼‚å¸¸å‘é‡è¡¨åŸºå€                           |
| `mepc`              | å¼‚å¸¸è¿”å›åœ°å€ï¼ˆException Program Counterï¼‰ |
| `mcause`            | å¼‚å¸¸åŸå›                               |
| `mtime`, `mtimecmp` | è®¡æ—¶å™¨å¯„å­˜å™¨                            |
| `mhartid`           | å½“å‰ç¡¬ä»¶çº¿ç¨‹ï¼ˆhartï¼‰çš„ ID                  |

#### ï¼ˆ3ï¼‰è®¿é—® CSR çš„æŒ‡ä»¤

| æŒ‡ä»¤                           | åŠŸèƒ½         | ç¤ºä¾‹                      |
| ---------------------------- | ---------- | ----------------------- |
| `csrrw rd, csr, rs1`         | è¯» CSR å¹¶å†™æ–°å€¼ | `csrrw x5, mstatus, x6` |
| `csrrs rd, csr, rs1`         | è¯» CSR å¹¶ç½®ä½  | `csrrs x5, mstatus, x7` |
| `csrrc rd, csr, rs1`         | è¯» CSR å¹¶æ¸…ä½  | `csrrc x5, mstatus, x0` |
| `csrrwi`, `csrrsi`, `csrrci` | ä½¿ç”¨ç«‹å³æ•°ç‰ˆæœ¬    | `csrrwi x0, mie, 1`     |

> CSR å¯„å­˜å™¨å±äº **ç³»ç»Ÿçº§æ“ä½œå¯¹è±¡**ï¼Œ
> ä»…åœ¨ç‰¹æƒæ¨¡å¼ï¼ˆå¦‚ M æ¨¡å¼ï¼‰ä¸‹è®¿é—®æœ‰æ•ˆã€‚

---

### 3.2 å†…å­˜ï¼ˆMemoryï¼‰

#### ï¼ˆ1ï¼‰å†…å­˜çš„ä½œç”¨

RISC-V æ˜¯ **åŠ è½½-å­˜å‚¨å‹ï¼ˆLoad/Store Architectureï¼‰** æ¶æ„ï¼š
åªæœ‰ **`lw`/`sw` ç­‰æŒ‡ä»¤å¯ä»¥è®¿é—®å†…å­˜**ï¼›
å…¶ä»–ç®—æœ¯ã€é€»è¾‘æŒ‡ä»¤éƒ½åªèƒ½åœ¨å¯„å­˜å™¨ä¸­æ“ä½œã€‚

#### ï¼ˆ2ï¼‰å¯»å€æ–¹å¼

RISC-V æ±‡ç¼–ä½¿ç”¨ **åŸºå€ + åç§»é‡ï¼ˆBase + Offsetï¼‰** å¯»å€ï¼š

```asm
lw x5, 8(x6)   # ä»åœ°å€ = x6 + 8 å¤„è¯»å– 32 ä½æ•°æ®åˆ° x5
sw x5, 0(x6)   # æŠŠ x5 çš„å†…å®¹å†™å…¥åœ°å€ = x6 + 0
```

* `x6`ï¼šåŸºå€å¯„å­˜å™¨ï¼Œå­˜æ”¾å†…å­˜åœ°å€ï¼›
* `8`ï¼šåç§»é‡ï¼ˆç«‹å³æ•°ï¼‰ï¼Œå¯ä»¥æ˜¯æ­£è´Ÿï¼›
* `x5`ï¼šç›®æ ‡å¯„å­˜å™¨ï¼ˆåŠ è½½ï¼‰æˆ–æºå¯„å­˜å™¨ï¼ˆå­˜å‚¨ï¼‰ã€‚

#### ï¼ˆ3ï¼‰æ•°æ®ç±»å‹ä¸å®½åº¦

| æŒ‡ä»¤           | æ•°æ®å®½åº¦           | æ“ä½œè¯´æ˜ |
| ------------ | -------------- | ---- |
| `lb` / `lbu` | 8 ä½ï¼ˆå¸¦ç¬¦å· / æ— ç¬¦å·ï¼‰ | åŠ è½½å­—èŠ‚ |
| `lh` / `lhu` | 16 ä½           | åŠ è½½åŠå­— |
| `lw`         | 32 ä½           | åŠ è½½å­—  |
| `sb`         | 8 ä½            | å­˜å‚¨å­—èŠ‚ |
| `sh`         | 16 ä½           | å­˜å‚¨åŠå­— |
| `sw`         | 32 ä½           | å­˜å‚¨å­—  |

#### ï¼ˆ4ï¼‰ç¤ºä¾‹

```asm
.data
value:  .word 10
.text
.globl _start
_start:
    la   x1, value     # åŠ è½½å˜é‡åœ°å€
    lw   x2, 0(x1)     # ä»å†…å­˜åŠ è½½æ•°æ® 10 åˆ° x2
    addi x2, x2, 1     # x2 = 11
    sw   x2, 0(x1)     # å†™å›åˆ°å†…å­˜
```

---

### 3.3 ç«‹å³æ•°ï¼ˆImmediate Valueï¼‰

#### ï¼ˆ1ï¼‰å®šä¹‰

ç«‹å³æ•°ï¼ˆImmediateï¼‰æ˜¯ç›´æ¥åµŒå…¥åˆ°æŒ‡ä»¤ä¸­çš„å¸¸é‡å€¼ã€‚
å®ƒä¸æ¥è‡ªå¯„å­˜å™¨æˆ–å†…å­˜ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨æŒ‡ä»¤ç¼–ç æœ¬èº«ã€‚

#### ï¼ˆ2ï¼‰ç”¨é€”

* ç®—æœ¯è¿ç®—ï¼š`addi x5, x6, 10`
* ä½ç§»æ“ä½œï¼š`slli x5, x6, 2`
* åœ°å€åç§»ï¼š`lw x5, 8(x6)`
* CSR æ“ä½œï¼š`csrrwi x0, mie, 1`

#### ï¼ˆ3ï¼‰ç«‹å³æ•°èŒƒå›´

RISC-V çš„ç«‹å³æ•°ä½å®½ç”±æŒ‡ä»¤ç±»å‹å†³å®šï¼š

| æŒ‡ä»¤ç±»å‹   | ç«‹å³æ•°å­—æ®µä½æ•° | èŒƒå›´ï¼ˆåè¿›åˆ¶ï¼‰       |
| ------ | ------- | ------------- |
| I-type | 12 ä½    | -2048 ï½ +2047 |
| S-type | 12 ä½    | -2048 ï½ +2047 |
| B-type | 13 ä½    | åˆ†æ”¯åç§»é‡         |
| U-type | 20 ä½    | é«˜ 20 ä½ç«‹å³æ•°     |
| J-type | 21 ä½    | è·³è½¬åç§»é‡         |

---

### 3.4 æ€»ç»“ï¼šRISC-V æ“ä½œå¯¹è±¡æ€»è§ˆ

| ç±»åˆ«      | åç§°          | ç¤ºä¾‹                                    | ç‰¹ç‚¹          |
| ------- | ----------- | ------------------------------------------ | ----------- |
| **å¯„å­˜å™¨** | é€šç”¨å¯„å­˜å™¨ã€ç³»ç»Ÿå¯„å­˜å™¨ | `add x5, x6, x7` / `csrrw x1, mstatus, x2` | CPU å†…éƒ¨é«˜é€Ÿå­˜å‚¨  |
| **å†…å­˜**  | é€šè¿‡åœ°å€è®¿é—®æ•°æ®    | `lw x5, 0(x6)` / `sw x5, 0(x6)`            | å¤–éƒ¨å­˜å‚¨è®¿é—®ï¼Œé€Ÿåº¦è¾ƒæ…¢ |
| **ç«‹å³æ•°** | å¸¸é‡æ“ä½œæ•°       | `addi x5, x6, 10`                          | å›ºå®šå€¼ï¼ŒåµŒå…¥æŒ‡ä»¤ä¸­   |

---

**æ€»ç»“ï¼š**

> RISC-V æ±‡ç¼–çš„â€œæ“ä½œå¯¹è±¡â€å°±æ˜¯æŒ‡ä»¤æ‰§è¡Œæ—¶æ‰€æ“ä½œçš„æ•°æ®æ¥æºä¸ç›®æ ‡ï¼š
>
> * **å¯„å­˜å™¨**ï¼šæ ¸å¿ƒè®¡ç®—å•ä½ï¼›
> * **å†…å­˜**ï¼šæ•°æ®å­˜å‚¨ç©ºé—´ï¼›
> * **ç«‹å³æ•°**ï¼šæŒ‡ä»¤ä¸­åµŒå…¥çš„å¸¸é‡ã€‚
>
> ä¸‰è€…æ„æˆäº† RISC-V æŒ‡ä»¤é›†çš„æ“ä½œåŸºç¡€ã€‚

---

## å››ã€RISC-Væ±‡ç¼–æŒ‡ä»¤

### 4.1 ç®—æœ¯ä¸é€»è¾‘è¿ç®—æŒ‡ä»¤ï¼ˆArithmetic & Logicï¼‰

| æŒ‡ä»¤      | åç§°       | æ ¼å¼(FMT) | Opcode  | funct3 | funct7  | åŠŸèƒ½æè¿°ï¼ˆC è¡¨è¾¾å¼ï¼‰           |
| ------- | -------- | ------- | ------- | ------ | ------- | --------------------- |
| `add`   | åŠ æ³•       | R       | 0110011 | 000    | 0000000 | rd = rs1 + rs2        |
| `sub`   | å‡æ³•       | R       | 0110011 | 000    | 0100000 | rd = rs1 - rs2        |
| `addi`  | åŠ ç«‹å³æ•°     | I       | 0010011 | 000    | â€”       | rd = rs1 + imm        |
| `lui`   | è£…è½½é«˜ä½ç«‹å³æ•°  | U       | 0110111 | â€”      | â€”       | rd = imm << 12        |
| `auipc` | ç«‹å³æ•°åŠ åˆ° PC | U       | 0010111 | â€”      | â€”       | rd = PC + (imm << 12) |
| `xor`   | å¼‚æˆ–       | R       | 0110011 | 100    | 0000000 | rd = rs1 ^ rs2        |
| `or`    | æˆ–        | R       | 0110011 | 110    | 0000000 | rd = rs1 | rs2        |
| `and`   | ä¸        | R       | 0110011 | 111    | 0000000 | rd = rs1 & rs2        |
| `xori`  | å¼‚æˆ–ç«‹å³æ•°    | I       | 0010011 | 100    | â€”       | rd = rs1 ^ imm        |
| `ori`   | æˆ–ç«‹å³æ•°     | I       | 0010011 | 110    | â€”       | rd = rs1 | imm        |
| `andi`  | ä¸ç«‹å³æ•°     | I       | 0010011 | 111    | â€”       | rd = rs1 & imm        |

---

### 4.2 ç§»ä½æŒ‡ä»¤ï¼ˆShift Instructionsï¼‰

| æŒ‡ä»¤     | åç§°      | æ ¼å¼ | Opcode  | funct3 | funct7  | åŠŸèƒ½æè¿°               |
| ------ | ------- | -- | ------- | ------ | ------- | ------------------ |
| `sll`  | é€»è¾‘å·¦ç§»    | R  | 0110011 | 001    | 0000000 | rd = rs1 << rs2    |
| `srl`  | é€»è¾‘å³ç§»    | R  | 0110011 | 101    | 0000000 | rd = rs1 >> rs2    |
| `sra`  | ç®—æœ¯å³ç§»    | R  | 0110011 | 101    | 0100000 | rd = rs1 >>> rs2   |
| `slli` | é€»è¾‘å·¦ç§»ç«‹å³æ•° | I  | 0010011 | 001    | 0000000 | rd = rs1 << shamt  |
| `srli` | é€»è¾‘å³ç§»ç«‹å³æ•° | I  | 0010011 | 101    | 0000000 | rd = rs1 >> shamt  |
| `srai` | ç®—æœ¯å³ç§»ç«‹å³æ•° | I  | 0010011 | 101    | 0100000 | rd = rs1 >>> shamt |

---

### 4.3 æ¯”è¾ƒæŒ‡ä»¤ï¼ˆSet-Less-Thanï¼‰

| æŒ‡ä»¤      | åç§°          | æ ¼å¼ | Opcode  | funct3 | funct7  | åŠŸèƒ½æè¿°                     |
| ------- | ----------- | -- | ------- | ------ | ------- | ------------------------ |
| `slt`   | å°äºåˆ™ç½® 1ï¼ˆæœ‰ç¬¦å·ï¼‰ | R  | 0110011 | 010    | 0000000 | rd = (rs1 < rs2) ? 1 : 0 |
| `sltu`  | å°äºåˆ™ç½® 1ï¼ˆæ— ç¬¦å·ï¼‰ | R  | 0110011 | 011    | 0000000 | rd = (rs1 < rs2) ? 1 : 0 |
| `slti`  | å°äºç«‹å³æ•°ï¼ˆæœ‰ç¬¦å·ï¼‰  | I  | 0010011 | 010    | â€”       | rd = (rs1 < imm) ? 1 : 0 |
| `sltiu` | å°äºç«‹å³æ•°ï¼ˆæ— ç¬¦å·ï¼‰  | I  | 0010011 | 011    | â€”       | rd = (rs1 < imm) ? 1 : 0 |

---

### 4.4 å†…å­˜è®¿é—®æŒ‡ä»¤ï¼ˆLoad / Storeï¼‰

| æŒ‡ä»¤    | åç§°     | æ ¼å¼ | Opcode  | funct3 | åŠŸèƒ½æè¿°                                |
| ----- | ------ | -- | ------- | ------ | ----------------------------------- |
| `lb`  | è¯»å­—èŠ‚    | I  | 0000011 | 000    | rd = M[rs1 + imm][7:0]              |
| `lh`  | è¯»åŠå­—    | I  | 0000011 | 001    | rd = M[rs1 + imm][15:0]             |
| `lw`  | è¯»å­—     | I  | 0000011 | 010    | rd = M[rs1 + imm][31:0]             |
| `lbu` | è¯»æ— ç¬¦å·å­—èŠ‚ | I  | 0000011 | 100    | rd = ZeroExtend(M[rs1 + imm][7:0])  |
| `lhu` | è¯»æ— ç¬¦å·åŠå­— | I  | 0000011 | 101    | rd = ZeroExtend(M[rs1 + imm][15:0]) |
| `sb`  | å­˜å­—èŠ‚    | S  | 0100011 | 000    | M[rs1 + imm][7:0] = rs2[7:0]        |
| `sh`  | å­˜åŠå­—    | S  | 0100011 | 001    | M[rs1 + imm][15:0] = rs2[15:0]      |
| `sw`  | å­˜å­—     | S  | 0100011 | 010    | M[rs1 + imm][31:0] = rs2[31:0]      |

---

### 4.5 åˆ†æ”¯ä¸è·³è½¬æŒ‡ä»¤ï¼ˆBranch & Jumpï¼‰

| æŒ‡ä»¤     | åç§°          | æ ¼å¼ | Opcode  | funct3 | åŠŸèƒ½æè¿°                               |
| ------ | ----------- | -- | ------- | ------ | ---------------------------------- |
| `beq`  | ç›¸ç­‰åˆ†æ”¯        | B  | 1100011 | 000    | if (rs1 == rs2) PC += imm          |
| `bne`  | ä¸ç­‰åˆ†æ”¯        | B  | 1100011 | 001    | if (rs1 != rs2) PC += imm          |
| `blt`  | å°äºåˆ†æ”¯ï¼ˆæœ‰ç¬¦å·ï¼‰   | B  | 1100011 | 100    | if (rs1 < rs2) PC += imm           |
| `bge`  | å¤§äºç­‰äºåˆ†æ”¯ï¼ˆæœ‰ç¬¦å·ï¼‰ | B  | 1100011 | 101    | if (rs1 >= rs2) PC += imm          |
| `bltu` | å°äºåˆ†æ”¯ï¼ˆæ— ç¬¦å·ï¼‰   | B  | 1100011 | 110    | if (rs1 < rs2) PC += imm           |
| `bgeu` | å¤§äºç­‰äºåˆ†æ”¯ï¼ˆæ— ç¬¦å·ï¼‰ | B  | 1100011 | 111    | if (rs1 >= rs2) PC += imm          |
| `jal`  | è·³è½¬å¹¶é“¾æ¥       | J  | 1101111 | â€”      | rd = PC + 4; PC += imm             |
| `jalr` | å¯„å­˜å™¨è·³è½¬å¹¶é“¾æ¥    | I  | 1100111 | 000    | rd = PC + 4; PC = (rs1 + imm) & ~1 |

---

### 4.6 æŒ‡ä»¤æ ¼å¼è¯´æ˜ï¼ˆInstruction Formatï¼‰

| æ ¼å¼         | åç§°              | å«ä¹‰è¯´æ˜                                      |
| ---------- | --------------- | ----------------------------------------- |
| **R-type** | Register        | å¯„å­˜å™¨ç±»å‹æŒ‡ä»¤ï¼Œç”¨äºå¯„å­˜å™¨é—´è¿ç®—ï¼ˆadd, sub, and, or, sllâ€¦ï¼‰ |
| **I-type** | Immediate       | ç«‹å³æ•°ç±»å‹æŒ‡ä»¤ï¼Œç”¨äºç«‹å³æ•°è¿ç®—ã€åŠ è½½ã€jalr                   |
| **S-type** | Store           | å­˜å‚¨ç±»å‹æŒ‡ä»¤ï¼ˆsw, sh, sbï¼‰                        |
| **B-type** | Branch          | åˆ†æ”¯æ¡ä»¶åˆ¤æ–­æŒ‡ä»¤ï¼ˆbeq, bne, blt, bgeâ€¦ï¼‰             |
| **U-type** | Upper Immediate | é«˜ä½ç«‹å³æ•°æŒ‡ä»¤ï¼ˆlui, auipcï¼‰                       |
| **J-type** | Jump            | è·³è½¬æŒ‡ä»¤ï¼ˆjalï¼‰                                 |

---

## äº”ã€RISC-Væ±‡ç¼–ä¼ªæŒ‡ä»¤

### 5.1 åŠ è½½ä¸å­˜å‚¨ï¼ˆLoad / Storeï¼‰

| ä¼ªæŒ‡ä»¤   | å±•å¼€ä¸ºåŸºæœ¬æŒ‡ä»¤  | å«ä¹‰è¯´æ˜ |                 
| ------- | -------------- | ------- | 
| `la rd, symbol` | `auipc rd, symbol[31:12]`<br>`addi rd, rd, symbol[11:0]` | åŠ è½½åœ°å€ï¼ˆLoad Addressï¼‰  |     
| `l{b/h/w/d} rd, symbol` | `auipc rd, symbol[31:12]`<br>`l{b/h/w/d} rd, symbol[11:0](rd)` | ä»å…¨å±€ç¬¦å·åŠ è½½æ•°æ®ï¼ˆLoad Globalï¼‰  |
| `s{b/h/w/d} rd, symbol, rt` | `auipc rt, symbol[31:12]`<br>`s{b/h/w/d} rd, symbol[11:0](rt)` | å‘å…¨å±€ç¬¦å·å­˜å‚¨æ•°æ®ï¼ˆStore Globalï¼‰ |
| `fl{w/d} rd, symbol, rt` | `auipc rt, symbol[31:12]`<br>`fl{w/d} rd, symbol[11:0](rt)` | æµ®ç‚¹åŠ è½½ï¼ˆFloating-point Load Globalï¼‰  |  
| `fs{w/d} rd, symbol, rt`  | `auipc rt, symbol[31:12]`<br>`fs{w/d} rd, symbol[11:0](rt)` | æµ®ç‚¹å­˜å‚¨ï¼ˆFloating-point Store Globalï¼‰ |  

---

### 5.2 å¸¸ç”¨ç«‹å³æ•°ä¸å¯„å­˜å™¨æ“ä½œ

| ä¼ªæŒ‡ä»¤             | åŸºæœ¬æŒ‡ä»¤                       | å«ä¹‰è¯´æ˜                   |
| --------------- | -------------------------- | ---------------------- |
| `nop`           | `addi x0, x0, 0`           | ç©ºæ“ä½œï¼ˆNo Operationï¼‰      |
| `li rd, imm`    | `addi rd, x0, imm` æˆ–å¤šæ¡åŠ è½½åºåˆ— | åŠ è½½ç«‹å³æ•°ï¼ˆLoad Immediateï¼‰  |
| `mv rd, rs`     | `addi rd, rs, 0`           | å¤åˆ¶å¯„å­˜å™¨ï¼ˆMove Registerï¼‰   |
| `not rd, rs`    | `xori rd, rs, -1`          | æŒ‰ä½å–åï¼ˆOneâ€™s Complementï¼‰ |
| `neg rd, rs`    | `sub rd, x0, rs`           | æ±‚è´Ÿï¼ˆTwoâ€™s Complementï¼‰   |
| `negw rd, rs`   | `subw rd, x0, rs`          | æ±‚è´Ÿï¼ˆå­—å®½ç‰ˆæœ¬ï¼‰               |
| `sext.w rd, rs` | `addiw rd, rs, 0`          | ç¬¦å·æ‰©å±•ï¼ˆSign Extend Wordï¼‰ |

---

### 5.3 æ¯”è¾ƒä¸æ¡ä»¶èµ‹å€¼ï¼ˆSet ifï¼‰

| ä¼ªæŒ‡ä»¤           | åŸºæœ¬æŒ‡ä»¤              | å«ä¹‰è¯´æ˜              |
| ------------- | ----------------- | ----------------- |
| `seqz rd, rs` | `sltiu rd, rs, 1` | è‹¥ rs = 0ï¼Œåˆ™ rd = 1 |
| `snez rd, rs` | `sltu rd, x0, rs` | è‹¥ rs â‰  0ï¼Œåˆ™ rd = 1 |
| `sltz rd, rs` | `slt rd, rs, x0`  | è‹¥ rs < 0ï¼Œåˆ™ rd = 1 |
| `sgtz rd, rs` | `slt rd, x0, rs`  | è‹¥ rs > 0ï¼Œåˆ™ rd = 1 |

---

### 5.4 æµ®ç‚¹ä¼ªæŒ‡ä»¤ï¼ˆFloating Pointï¼‰

| ä¼ªæŒ‡ä»¤             | åŸºæœ¬æŒ‡ä»¤                  | å«ä¹‰è¯´æ˜     |
| --------------- | --------------------- | -------- |
| `fmv.s rd, rs`  | `fsgnj.s rd, rs, rs`  | å¤åˆ¶å•ç²¾åº¦å¯„å­˜å™¨ |
| `fabs.s rd, rs` | `fsgnjx.s rd, rs, rs` | å•ç²¾åº¦ç»å¯¹å€¼   |
| `fneg.s rd, rs` | `fsgnjn.s rd, rs, rs` | å•ç²¾åº¦å–è´Ÿ    |
| `fmv.d rd, rs`  | `fsgnj.d rd, rs, rs`  | å¤åˆ¶åŒç²¾åº¦å¯„å­˜å™¨ |
| `fabs.d rd, rs` | `fsgnjx.d rd, rs, rs` | åŒç²¾åº¦ç»å¯¹å€¼   |
| `fneg.d rd, rs` | `fsgnjn.d rd, rs, rs` | åŒç²¾åº¦å–è´Ÿ    |

---

### 5.5 æ¡ä»¶åˆ†æ”¯ï¼ˆBranchï¼‰

| ä¼ªæŒ‡ä»¤               | åŸºæœ¬æŒ‡ä»¤                 | å«ä¹‰è¯´æ˜         |
| ----------------- | -------------------- | ------------ |
| `beqz rs, offset` | `beq rs, x0, offset` | è‹¥ rs = 0 åˆ™åˆ†æ”¯ |
| `bnez rs, offset` | `bne rs, x0, offset` | è‹¥ rs â‰  0 åˆ™åˆ†æ”¯ |
| `blez rs, offset` | `bge x0, rs, offset` | è‹¥ rs â‰¤ 0 åˆ™åˆ†æ”¯ |
| `bgez rs, offset` | `bge rs, x0, offset` | è‹¥ rs â‰¥ 0 åˆ™åˆ†æ”¯ |
| `bltz rs, offset` | `blt rs, x0, offset` | è‹¥ rs < 0 åˆ™åˆ†æ”¯ |
| `bgtz rs, offset` | `blt x0, rs, offset` | è‹¥ rs > 0 åˆ™åˆ†æ”¯ |

---

### 5.6 æ¯”è¾ƒå¯„å­˜å™¨åˆ†æ”¯ï¼ˆBranch Compareï¼‰

| ä¼ªæŒ‡ä»¤                   | åŸºæœ¬æŒ‡ä»¤                  | å«ä¹‰è¯´æ˜              |
| --------------------- | --------------------- | ----------------- |
| `bgt rs, rt, offset`  | `blt rt, rs, offset`  | è‹¥ rs > rt åˆ™åˆ†æ”¯     |
| `ble rs, rt, offset`  | `bge rt, rs, offset`  | è‹¥ rs â‰¤ rt åˆ™åˆ†æ”¯     |
| `bgtu rs, rt, offset` | `bltu rt, rs, offset` | è‹¥ rs > rtï¼ˆæ— ç¬¦å·ï¼‰åˆ™åˆ†æ”¯ |
| `bleu rs, rt, offset` | `bgeu rt, rs, offset` | è‹¥ rs â‰¤ rtï¼ˆæ— ç¬¦å·ï¼‰åˆ™åˆ†æ”¯ |

---

### 5.7 è·³è½¬ä¸å­ç¨‹åºè°ƒç”¨ï¼ˆJump & Callï¼‰

| ä¼ªæŒ‡ä»¤           | åŸºæœ¬æŒ‡ä»¤                                                     | å«ä¹‰è¯´æ˜          |
| ------------- | -------------------------------------------------------- | ------------- |
| `j offset`    | `jal x0, offset`                                         | æ— æ¡ä»¶è·³è½¬ï¼ˆJumpï¼‰   |
| `jal offset`  | `jal x1, offset`                                         | è·³è½¬å¹¶é“¾æ¥ï¼ˆä¿å­˜è¿”å›åœ°å€ï¼‰ |
| `jr rs`       | `jalr x0, rs, 0`                                         | è·³è½¬å¯„å­˜å™¨åœ°å€       |
| `jalr rs`     | `jalr x1, rs, 0`                                         | è·³è½¬å¹¶é“¾æ¥å¯„å­˜å™¨åœ°å€    |
| `ret`         | `jalr x0, x1, 0`                                         | ä»å­ç¨‹åºè¿”å›        |
| `call offset` | `auipc x1, offset[31:12]`<br>`jalr x1, x1, offset[11:0]` | è°ƒç”¨è¿œç¨‹å­ç¨‹åº       |
| `tail offset` | `auipc x6, offset[31:12]`<br>`jalr x0, x6, offset[11:0]` | å°¾è°ƒç”¨å­ç¨‹åºï¼ˆæ— è¿”å›ï¼‰   |

---

### 5.8 å†…å­˜åŒæ­¥ä¸å±éšœï¼ˆFenceï¼‰

| ä¼ªæŒ‡ä»¤     | åŸºæœ¬æŒ‡ä»¤               | å«ä¹‰è¯´æ˜                 |
| ------- | ------------------ | -------------------- |
| `fence` | `fence iorw, iorw` | åŒæ­¥æ‰€æœ‰å†…å­˜ä¸ I/O æ“ä½œï¼ˆå†…å­˜å±éšœï¼‰ |

---

### 5.9 æ€»ç»“ï¼š

* **ä¼ªæŒ‡ä»¤ï¼ˆPseudo Instructionï¼‰** æ˜¯ä¸ºæé«˜å¯è¯»æ€§ä¸ç®€åŒ–ç¼–ç¨‹è€Œè®¾è®¡çš„æ±‡ç¼–å±‚è¯­æ³•ã€‚
* æ±‡ç¼–å™¨åœ¨ç”Ÿæˆæœºå™¨ç å‰ï¼Œä¼šè‡ªåŠ¨å°†å®ƒä»¬**ç¿»è¯‘æˆæ ‡å‡† RISC-V åŸºæœ¬æŒ‡ä»¤åºåˆ—**ã€‚
* å¸¸è§ç±»åˆ«åŒ…æ‹¬ï¼š

  * åœ°å€ä¸ç«‹å³æ•°åŠ è½½ï¼ˆ`la`, `li`ï¼‰
  * æ•°æ®ç§»åŠ¨ä¸æ¯”è¾ƒï¼ˆ`mv`, `neg`, `seqz`ï¼‰
  * æ¡ä»¶è·³è½¬ï¼ˆ`beqz`, `bgt`ï¼‰
  * å­ç¨‹åºæ§åˆ¶ï¼ˆ`call`, `ret`, `tail`ï¼‰
  * å†…å­˜åŒæ­¥ï¼ˆ`fence`ï¼‰

---

## å…­ã€RISC-Vå¯»å€æ¨¡å¼

### 6.1 æ¦‚å¿µè¯´æ˜

**å¯»å€æ¨¡å¼ï¼ˆAddressing Modeï¼‰**ï¼š
æŒ‡ä»¤è®¿é—®æ“ä½œæ•°ï¼ˆæ•°æ®ï¼‰æ—¶é‡‡ç”¨çš„æ–¹å¼ï¼Œå†³å®šäº†æ“ä½œæ•°â€œä»å“ªé‡Œæ¥â€ã€‚

RISC-V çš„è®¾è®¡éµå¾ª **ç²¾ç®€ï¼ˆRISCï¼‰ç†å¿µ**ï¼Œå¯»å€æ¨¡å¼æ•°é‡å°‘ä½†è¦†ç›–é¢å¹¿ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ **4 ç§æ ¸å¿ƒå¯»å€æ¨¡å¼**ã€‚

---

### 6.2 RISC-V çš„å››ç§ä¸»è¦å¯»å€æ¨¡å¼

|  åºå· | å¯»å€æ¨¡å¼          | è‹±æ–‡å                      | ç¤ºä¾‹                | åœ°å€è®¡ç®—/å«ä¹‰                 | å¸¸è§ç”¨é€”       |
| :-: | :------------ | :----------------------- | :---------------- | :---------------------- | :--------- |
|  1  | **ç«‹å³æ•°å¯»å€**     | Immediate Addressing     | `addi x5, x6, 10` | æ“ä½œæ•° = å¯„å­˜å™¨å€¼ + ç«‹å³æ•°        | ç®—æœ¯ã€é€»è¾‘è®¡ç®—    |
|  2  | **å¯„å­˜å™¨å¯»å€**     | Register Addressing      | `add x3, x1, x2`  | æ“ä½œæ•°å…¨éƒ¨æ¥è‡ªå¯„å­˜å™¨              | ç®—æœ¯ã€é€»è¾‘è¿ç®—    |
|  3  | **åŸºå€ + åç§»å¯»å€** | Base + Offset Addressing | `lw x5, 8(x6)`    | æœ‰æ•ˆåœ°å€ = å¯„å­˜å™¨(x6) + åç§»é‡(8) | è®¿é—®å†…å­˜ã€æ•°ç»„ã€æ ˆ  |
|  4  | **PC ç›¸å¯¹å¯»å€**   | PC-Relative Addressing   | `jal x1, label`   | æœ‰æ•ˆåœ°å€ = å½“å‰ PC + åç§»é‡      | è·³è½¬ã€åˆ†æ”¯ã€è®¿é—®å¸¸é‡ |

---

### 6.3 è¯¦ç»†è¯´æ˜

### 1ï¸âƒ£ ç«‹å³æ•°å¯»å€ï¼ˆImmediate Addressingï¼‰

* æ“ä½œæ•°ç›´æ¥å†™åœ¨æŒ‡ä»¤ä¸­ã€‚
* æ— éœ€è®¿é—®å†…å­˜ã€‚
* å¸¸è§æŒ‡ä»¤ï¼š`addi`, `andi`, `ori`, `xori`, `slti`

ğŸ“˜ä¾‹ï¼š

```asm
addi x5, x6, 10   # x5 = x6 + 10
andi x7, x7, 0xFF # x7 = x7 & 0xFF
```

ğŸ§® ç‰¹ç‚¹ï¼š

* ç«‹å³æ•°é€šå¸¸ä¸º 12 ä½æœ‰ç¬¦å·æ•°ï¼ˆèŒƒå›´ Â±2048ï¼‰ã€‚
* å¤§æ•°éœ€ç”¨ `lui` æˆ– `auipc` è¾…åŠ©åŠ è½½ã€‚

---

### 2ï¸âƒ£ å¯„å­˜å™¨å¯»å€ï¼ˆRegister Addressingï¼‰

* æ‰€æœ‰æ“ä½œæ•°åœ¨å¯„å­˜å™¨ä¸­ã€‚
* é€Ÿåº¦æœ€å¿«ï¼Œä¸è®¿é—®å†…å­˜ã€‚
* å¸¸è§æŒ‡ä»¤ï¼š`add`, `sub`, `and`, `or`, `xor`, `sll`, `srl`

ğŸ“˜ä¾‹ï¼š

```asm
add x3, x1, x2   # x3 = x1 + x2
sub x4, x4, x5   # x4 = x4 - x5
```

ğŸ§® ç‰¹ç‚¹ï¼š

* CPU ç›´æ¥åœ¨å¯„å­˜å™¨é—´æ“ä½œï¼Œå»¶è¿Ÿä½ã€‚
* å‡ ä¹æ‰€æœ‰ç®—æœ¯é€»è¾‘æŒ‡ä»¤éƒ½æœ‰å¯„å­˜å™¨ç‰ˆæœ¬ã€‚

---

### 3ï¸âƒ£ åŸºå€ + åç§»å¯»å€ï¼ˆBase + Offset Addressingï¼‰

* è®¿å­˜æŒ‡ä»¤ä¸»è¦ä½¿ç”¨æ­¤æ¨¡å¼ã€‚
* é€šè¿‡å¯„å­˜å™¨ + åç§»é‡è®¡ç®—è®¿é—®åœ°å€ã€‚
* å¸¸è§æŒ‡ä»¤ï¼š`lw`, `sw`, `lb`, `sb`

ğŸ“˜ä¾‹ï¼š

```asm
lw x5, 8(x6)   # ä»å†…å­˜åœ°å€ (x6 + 8) è¯»å…¥ 32 ä½æ•°æ®åˆ° x5
sw x7, 12(x8)  # æŠŠ x7 çš„å†…å®¹å­˜åˆ°åœ°å€ (x8 + 12)
```

ğŸ§® ç‰¹ç‚¹ï¼š

* åç§»é‡æ˜¯ 12 ä½æœ‰ç¬¦å·æ•°ã€‚
* å¸¸ç”¨äºè®¿é—®æ•°ç»„å…ƒç´ ã€ç»“æ„ä½“å­—æ®µæˆ–æ ˆå¸§å˜é‡ã€‚

---

### 4ï¸âƒ£ PC ç›¸å¯¹å¯»å€ï¼ˆPC-Relative Addressingï¼‰

* åœ°å€ = å½“å‰ PC + åç§»é‡ã€‚
* å¸¸ç”¨äºåˆ†æ”¯ã€è·³è½¬ã€å‡½æ•°è°ƒç”¨å’Œå¸¸é‡åŠ è½½ã€‚

ğŸ“˜ä¾‹ï¼š

```asm
beq x1, x2, label  # è‹¥ x1 == x2ï¼Œåˆ™è·³è½¬åˆ° label
jal ra, func        # è·³è½¬åˆ° funcï¼Œå¹¶ä¿å­˜è¿”å›åœ°å€åˆ° ra
```

ğŸ§® ç‰¹ç‚¹ï¼š

* `beq`, `bne`ï¼š13 ä½åç§»é‡
* `jal`ï¼š21 ä½åç§»é‡
* `auipc`ï¼šç”¨äºç”Ÿæˆç›¸å¯¹ PC çš„åœ°å€åŸºå‡†ï¼ˆä½ç½®æ— å…³ä»£ç ï¼‰

---

### 6.4 æ¨¡å¼å¯¹æ¯”æ€»ç»“

| æ¨¡å¼åç§°    | æ˜¯å¦è®¿å­˜ | æ˜¯å¦å«ç«‹å³æ•° | åœ°å€è®¡ç®—å…¬å¼               | å…¸å‹åº”ç”¨    |
| :------ | :--: | :----: | :------------------- | :------ |
| ç«‹å³æ•°å¯»å€   |   å¦  |    âœ…   | æ— åœ°å€è®¡ç®—ï¼Œç«‹å³æ•°ç›´æ¥ä½¿ç”¨        | ç®—æœ¯é€»è¾‘    |
| å¯„å­˜å™¨å¯»å€   |   å¦  |    âŒ   | æ— åœ°å€è®¡ç®—                | çº¯å¯„å­˜å™¨æ“ä½œ  |
| åŸºå€+åç§»å¯»å€ |   âœ…  |    âœ…   | `EA = base + offset` | è®¿å­˜ã€æ ˆã€æ•°ç»„ |
| PC ç›¸å¯¹å¯»å€ |   âœ…  |    âœ…   | `EA = PC + offset`   | åˆ†æ”¯ã€è·³è½¬   |

---

> **é¢å¤–è¯´æ˜**

* RISC-V ä¸æ”¯æŒï¼š

  * é—´æ¥å¯»å€ï¼ˆ`[x1]`ï¼‰
  * å˜å€å¯»å€ï¼ˆ`[x1 + x2]`ï¼‰
  * å†…å­˜åˆ°å†…å­˜æ“ä½œ
    ğŸ‘‰ å¿…é¡»é€šè¿‡ **å¯„å­˜å™¨ä½œä¸ºä¸­é—´å±‚**ï¼ˆload â†’ è¿ç®— â†’ storeï¼‰ã€‚

* è®¾è®¡ç†å¿µï¼š

  > â€œç®€å•å³é«˜æ•ˆâ€ â€”â€” å°‘æ•°å¯»å€æ¨¡å¼å³å¯è¦†ç›–æ‰€æœ‰å¸¸è§éœ€æ±‚ã€‚

---

### 6.5 æ€»ç»“

> **RISC-V çš„å››ç§æ ¸å¿ƒå¯»å€æ¨¡å¼**ï¼š
>
> * **ç«‹å³æ•°å¯»å€**ï¼šå€¼åœ¨æŒ‡ä»¤ä¸­
> * **å¯„å­˜å™¨å¯»å€**ï¼šå€¼åœ¨å¯„å­˜å™¨ä¸­
> * **åŸºå€+åç§»å¯»å€**ï¼šè®¿é—®å†…å­˜
> * **PC ç›¸å¯¹å¯»å€**ï¼šè·³è½¬ä¸å®šä½

---

## ä¸ƒã€RISC-Vå‡½æ•°è°ƒç”¨çº¦å®šï¼ˆCalling Conventionï¼‰

### 7.1 å‡½æ•°è°ƒç”¨çº¦å®šæ¦‚å¿µ

> **å‡½æ•°è°ƒç”¨çº¦å®šï¼ˆCalling Conventionï¼‰**
> æ˜¯ç¼–è¯‘å™¨å’Œæ±‡ç¼–ç¨‹åºå‘˜ä¹‹é—´çš„è§„åˆ™ï¼Œè§„å®šï¼š

* å‡½æ•°å‚æ•°å¦‚ä½•ä¼ é€’
* è¿”å›å€¼å­˜æ”¾ä½ç½®
* å“ªäº›å¯„å­˜å™¨ç”±è°ƒç”¨è€…ï¼ˆCallerï¼‰ä¿å­˜
* å“ªäº›å¯„å­˜å™¨ç”±è¢«è°ƒç”¨è€…ï¼ˆCalleeï¼‰ä¿å­˜
* æ ˆçš„ä½¿ç”¨æ–¹å¼

RISC-V éµå¾ª **System V ABI** æ ‡å‡†ã€‚

---

### 7.2 32 ä¸ªé€šç”¨å¯„å­˜å™¨æ€»ç»“è¡¨ï¼ˆRV32ï¼‰

|  ç¼–å· |   å¯„å­˜å™¨å  |           ABI å           | ç”¨é€”è¯´æ˜         |    ä¿å­˜è´£ä»»    |
| :-: | :-----: | :-----------------------: | :----------- | :--------: |
|  x0 |   zero  |            å¸¸é‡ 0           | æ°¸è¿œä¸º 0        |     ä¸é€‚ç”¨    |
|  x1 |    ra   |       Return Address      | å‡½æ•°è¿”å›åœ°å€       | **Caller** |
|  x2 |    sp   |       Stack Pointer       | æ ˆé¡¶æŒ‡é’ˆ         | **Callee** |
|  x3 |    gp   |       Global Pointer      | å…¨å±€å˜é‡åŸºå€       |     ä¸å˜     |
|  x4 |    tp   |       Thread Pointer      | çº¿ç¨‹å±€éƒ¨å­˜å‚¨æŒ‡é’ˆ     |     ä¸å˜     |
|  x5 |    t0   |         Temporary         | ä¸´æ—¶å¯„å­˜å™¨        | **Caller** |
|  x6 |    t1   |         Temporary         | ä¸´æ—¶å¯„å­˜å™¨        | **Caller** |
|  x7 |    t2   |         Temporary         | ä¸´æ—¶å¯„å­˜å™¨        | **Caller** |
|  x8 | s0 / fp |   Saved / Frame Pointer   | ä¿å­˜å¯„å­˜å™¨ / æ ˆå¸§åŸºå€ | **Callee** |
|  x9 |    s1   |           Saved           | ä¿å­˜å¯„å­˜å™¨        | **Callee** |
| x10 |    a0   | Argument / Return Value 0 | å‚æ•° 1 / è¿”å›å€¼   | **Caller** |
| x11 |    a1   | Argument / Return Value 1 | å‚æ•° 2 / è¿”å›å€¼   | **Caller** |
| x12 |    a2   |          Argument         | å‚æ•° 3         | **Caller** |
| x13 |    a3   |          Argument         | å‚æ•° 4         | **Caller** |
| x14 |    a4   |          Argument         | å‚æ•° 5         | **Caller** |
| x15 |    a5   |          Argument         | å‚æ•° 6         | **Caller** |
| x16 |    a6   |          Argument         | å‚æ•° 7         | **Caller** |
| x17 |    a7   |          Argument         | å‚æ•° 8 / ç³»ç»Ÿè°ƒç”¨å· | **Caller** |
| x18 |    s2   |           Saved           | ä¿å­˜å¯„å­˜å™¨        | **Callee** |
| x19 |    s3   |           Saved           | ä¿å­˜å¯„å­˜å™¨        | **Callee** |
| x20 |    s4   |           Saved           | ä¿å­˜å¯„å­˜å™¨        | **Callee** |
| x21 |    s5   |           Saved           | ä¿å­˜å¯„å­˜å™¨        | **Callee** |
| x22 |    s6   |           Saved           | ä¿å­˜å¯„å­˜å™¨        | **Callee** |
| x23 |    s7   |           Saved           | ä¿å­˜å¯„å­˜å™¨        | **Callee** |
| x24 |    s8   |           Saved           | ä¿å­˜å¯„å­˜å™¨        | **Callee** |
| x25 |    s9   |           Saved           | ä¿å­˜å¯„å­˜å™¨        | **Callee** |
| x26 |   s10   |           Saved           | ä¿å­˜å¯„å­˜å™¨        | **Callee** |
| x27 |   s11   |           Saved           | ä¿å­˜å¯„å­˜å™¨        | **Callee** |
| x28 |    t3   |         Temporary         | ä¸´æ—¶å¯„å­˜å™¨        | **Caller** |
| x29 |    t4   |         Temporary         | ä¸´æ—¶å¯„å­˜å™¨        | **Caller** |
| x30 |    t5   |         Temporary         | ä¸´æ—¶å¯„å­˜å™¨        | **Caller** |
| x31 |    t6   |         Temporary         | ä¸´æ—¶å¯„å­˜å™¨        | **Caller** |

---

### 7.3 å‚æ•°ä¸è¿”å›å€¼è§„åˆ™

| é¡¹ç›®   | è§„åˆ™                             |
| :--- | :----------------------------- |
| å‚æ•°ä¼ é€’ | å‰ 8 ä¸ªå‚æ•°ä½¿ç”¨ `a0â€“a7`ï¼›è¶…å‡ºéƒ¨åˆ†é€šè¿‡æ ˆä¼ é€’    |
| è¿”å›å€¼  | ä¸€ä¸ªè¿”å›å€¼ï¼š`a0`ï¼›ä¸¤ä¸ªè¿”å›å€¼ï¼š`a0â€“a1`       |
| è°ƒç”¨æŒ‡ä»¤ | `jal ra, func` ï¼ˆè·³è½¬å¹¶ä¿å­˜è¿”å›åœ°å€åˆ° raï¼‰ |
| è¿”å›æŒ‡ä»¤ | `ret`ï¼ˆç­‰ä»·äº `jr ra`ï¼‰             |

---

### 7.4 å‡½æ•°è°ƒç”¨æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

#### è°ƒç”¨è€…ï¼ˆCallerï¼‰è´Ÿè´£ï¼š

1. æŠŠå‚æ•°æ”¾å…¥ `a0â€“a7` æˆ–æ ˆä¸­
2. ä¿å­˜å¯èƒ½è¢«è¦†ç›–çš„å¯„å­˜å™¨ï¼ˆ`t0â€“t6`ï¼Œå¦‚è¿˜éœ€ä½¿ç”¨ï¼‰
3. è°ƒç”¨å‡½æ•°ï¼š`jal ra, func`
4. ä» `a0â€“a1` å–è¿”å›å€¼

#### è¢«è°ƒç”¨è€…ï¼ˆCalleeï¼‰è´Ÿè´£ï¼š

1. å»ºç«‹æ ˆå¸§ï¼šä¿å­˜ `ra`ã€`s0â€“s11`ã€`sp`
2. æ‰§è¡Œå‡½æ•°ä½“é€»è¾‘
3. æ¢å¤å¯„å­˜å™¨ä¸æ ˆå¸§
4. ä½¿ç”¨ `ret` è¿”å›

---

### 7.5 æ ˆå¸§ç»“æ„ç¤ºæ„ï¼ˆStack Frameï¼‰

```
é«˜åœ°å€
â”‚
â”‚ ä¸Šå±‚å‡½æ•°çš„æ ˆå¸§
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ ä¿å­˜çš„ raï¼ˆè¿”å›åœ°å€ï¼‰
â”‚ ä¿å­˜çš„ s å¯„å­˜å™¨ï¼ˆs0â€“s11ï¼‰
â”‚ å±€éƒ¨å˜é‡ / ä¸´æ—¶ç©ºé—´
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â† spï¼ˆå½“å‰å‡½æ•°æ ˆé¡¶ï¼‰
â”‚ è°ƒç”¨å‚æ•°ï¼ˆè¶…è¿‡ 8 ä¸ªæ—¶ï¼‰
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä½åœ°å€
```

ğŸ“˜ æ ˆå‘ä½åœ°å€æ–¹å‘å¢é•¿ã€‚
å‡½æ•°è¿›å…¥æ—¶ä¸€èˆ¬ï¼š

```asm
addi sp, sp, -frame_size
sw   ra, offset(sp)
sw   s0, offset(sp)
```

å‡½æ•°è¿”å›æ—¶ï¼š

```asm
lw   ra, offset(sp)
lw   s0, offset(sp)
addi sp, sp, frame_size
ret
```

---

### 7.6 å¯„å­˜å™¨ä¿å­˜åŸåˆ™æ€»ç»“

| ç±»åˆ«    | å¯„å­˜å™¨èŒƒå›´      | è°è´Ÿè´£ä¿å­˜  | ä½¿ç”¨è¯´æ˜          |
| :---- | :--------- | :----- | :------------ |
| æ°¸ä¹…å¯„å­˜å™¨ | x0, gp, tp | ä¸å˜     | å›ºå®šåŠŸèƒ½          |
| æ ˆä¸è¿”å›  | sp, ra     | Callee | å‡½æ•°æ¡†æ¶ä¸è¿”å›åœ°å€     |
| å‚æ•°å¯„å­˜å™¨ | a0â€“a7      | Caller | å‚æ•°ä¼ é€’ / è¿”å›å€¼    |
| ä¿å­˜å¯„å­˜å™¨ | s0â€“s11     | Callee | ä½¿ç”¨å‰å¿…é¡»ä¿å­˜ï¼Œè¿”å›å‰æ¢å¤ |
| ä¸´æ—¶å¯„å­˜å™¨ | t0â€“t6      | Caller | è°ƒç”¨å‰è‹¥è¦ä¿ç•™éœ€è‡ªè¡Œä¿å­˜  |

---

> **â€œa ä¼ å‚ï¼Œt æš‚ç”¨ï¼Œs è¦å®ˆï¼Œra å›å®¶ã€‚â€**

* **a**ï¼ša0â€“a7 ä¼ å‚æ•° / è¿”å›å€¼
* **t**ï¼št0â€“t6 ä¸´æ—¶ç”¨ï¼ˆè°ƒç”¨è€…ä¿å­˜ï¼‰
* **s**ï¼šs0â€“s11 è¦å®ˆï¼ˆè¢«è°ƒç”¨è€…ä¿å­˜ï¼‰
* **ra**ï¼šè¿”å›åœ°å€ï¼Œæœ€ç»ˆâ€œå›å®¶â€

---

### 7.8 è°ƒç”¨ç¤ºä¾‹

```asm
# int add(int a, int b) { return a + b; }

add:
    add a0, a0, a1   # è®¡ç®—ç»“æœæ”¾åœ¨ a0
    ret              # è¿”å›

# int main() { return add(3, 4); }

main:
    addi sp, sp, -16
    sw ra, 12(sp)

    li a0, 3
    li a1, 4
    jal ra, add      # è°ƒç”¨ add

    lw ra, 12(sp)
    addi sp, sp, 16
    ret
```

---

### 7.9 æ€»ç»“

> **RISC-V å‡½æ•°è°ƒç”¨çš„æ ¸å¿ƒæ€æƒ³ï¼š**
>
> * å‚æ•°æ”¾ a å¯„å­˜å™¨ï¼Œè¿”å›å€¼æ”¾ a0
> * æ ˆå‘ä¸‹å¢é•¿ï¼Œra å­˜è¿”å›åœ°å€
> * t å¯„å­˜å™¨ç”±è°ƒç”¨è€…è´Ÿè´£ï¼Œs å¯„å­˜å™¨ç”±è¢«è°ƒç”¨è€…è´Ÿè´£
> * ret ç­‰ä»·äº â€œè¿”å›åˆ° raâ€

---

## å…«ã€Cè¯­è¨€ä¸RISC-Væ±‡ç¼–æŒ‡ä»¤è”åˆç¼–è¯‘

### 8.1 åŸºæœ¬æ¦‚å¿µ

* **è”åˆç¼–è¯‘**ï¼šæŒ‡å°†Cè¯­è¨€ä»£ç å’Œæ±‡ç¼–ä»£ç ä¸€èµ·ç¼–è¯‘ï¼Œæœ€ç»ˆç”Ÿæˆå¯ä»¥é“¾æ¥è¿è¡Œçš„ç›®æ ‡æ–‡ä»¶æˆ–å¯æ‰§è¡Œæ–‡ä»¶ã€‚
* **åº”ç”¨åœºæ™¯**ï¼š

  * æ€§èƒ½ä¼˜åŒ–æ—¶æ‰‹å†™å…³é”®æ±‡ç¼–ä»£ç ã€‚
  * è®¿é—®ç‰¹å®šç¡¬ä»¶æˆ–ç³»ç»Ÿè°ƒç”¨ã€‚
  * å®ç°å¯åŠ¨ä»£ç ã€å¼‚å¸¸å¤„ç†æˆ–åº•å±‚é©±åŠ¨ç­‰ã€‚
* **RISC-Væ±‡ç¼–**ï¼šåŸºäºRISC-VæŒ‡ä»¤é›†æ¶æ„çš„æ±‡ç¼–è¯­è¨€ï¼ŒåŒ…å«32ä¸ªé€šç”¨å¯„å­˜å™¨åŠç‰¹æ®Šå¯„å­˜å™¨ã€‚

---

### 8.2 RISC-Vè°ƒç”¨çº¦å®šï¼ˆABIï¼‰

è°ƒç”¨çº¦å®šå®šä¹‰äº†å‡½æ•°è°ƒç”¨æ—¶å¯„å­˜å™¨ã€æ ˆç­‰ä½¿ç”¨è§„åˆ™ï¼Œä¿è¯Cä¸æ±‡ç¼–ä»£ç é—´çš„äº’æ“ä½œæ€§ã€‚

| å¯„å­˜å™¨     | ABIåç§°  | ç”¨é€”          | è°ƒç”¨è€…/è¢«è°ƒç”¨è€…ä¿å­˜     |
| ------- | ------ | ----------- | -------------- |
| x1      | ra     | è¿”å›åœ°å€        | è°ƒç”¨è€…ä¿å­˜ï¼ˆCallerï¼‰  |
| x2      | sp     | æ ˆæŒ‡é’ˆ         | è¢«è°ƒç”¨è€…ä¿å­˜ï¼ˆCalleeï¼‰ |
| x3      | gp     | å…¨å±€æŒ‡é’ˆ        | ç¨³å®š             |
| x4      | tp     | çº¿ç¨‹æŒ‡é’ˆ        | ç¨³å®š             |
| x5-x7   | t0-t2  | ä¸´æ—¶å¯„å­˜å™¨       | è°ƒç”¨è€…ä¿å­˜          |
| x8      | s0/fp  | ä¿å­˜å¯„å­˜å™¨/å¸§æŒ‡é’ˆ   | è¢«è°ƒç”¨è€…ä¿å­˜         |
| x9      | s1     | ä¿å­˜å¯„å­˜å™¨       | è¢«è°ƒç”¨è€…ä¿å­˜         |
| x10-x17 | a0-a7  | å‡½æ•°å‚æ•°/è¿”å›å€¼å¯„å­˜å™¨ | è°ƒç”¨è€…ä¿å­˜          |
| x18-x27 | s2-s11 | ä¿å­˜å¯„å­˜å™¨       | è¢«è°ƒç”¨è€…ä¿å­˜         |
| x28-x31 | t3-t6  | ä¸´æ—¶å¯„å­˜å™¨       | è°ƒç”¨è€…ä¿å­˜          |

**å…³é”®ç‚¹**ï¼š

* å‚æ•°æœ€å¤šé€šè¿‡a0~a7å¯„å­˜å™¨ä¼ é€’ï¼Œè¶…è¿‡8ä¸ªå‚æ•°ç”¨æ ˆä¼ ã€‚
* è¿”å›å€¼ç”¨a0ï¼ˆå’Œa1ï¼‰ä¼ é€’ã€‚
* è¢«è°ƒç”¨å‡½æ•°è´Ÿè´£ä¿å­˜så¯„å­˜å™¨ï¼ˆä¿å­˜å¯„å­˜å™¨ï¼‰ã€‚
* è°ƒç”¨è€…è´Ÿè´£ä¿å­˜tå¯„å­˜å™¨ï¼ˆä¸´æ—¶å¯„å­˜å™¨ï¼‰å’Œraã€‚

---

### 8.3 Cä¸æ±‡ç¼–çš„äº’æ“ä½œ

### 1. æ±‡ç¼–ä¸­è°ƒç”¨Cå‡½æ•°

* é€šè¿‡`call`æŒ‡ä»¤è°ƒç”¨Cå‡½æ•°åï¼ˆç¬¦å·åï¼‰ï¼Œè¦ä¿è¯å‚æ•°å·²æŒ‰ABIæ”¾åœ¨å¯¹åº”å¯„å­˜å™¨ã€‚
* æ±‡ç¼–ä¸­è°ƒç”¨Cå‡½æ•°åï¼Œè¿”å›å€¼åœ¨a0ï¼ˆå’Œa1ï¼‰ã€‚

ç¤ºä¾‹ï¼š

```asm
    li a0, 5
    li a1, 7
    call add_two_numbers    # è°ƒç”¨Cå‡½æ•° int add_two_numbers(int x, int y);
    # è¿”å›å€¼åœ¨a0
```

### 2. Cä»£ç è°ƒç”¨æ±‡ç¼–å‡½æ•°

* æ±‡ç¼–å‡½æ•°ç”¨ `.global` å¯¼å‡ºç¬¦å·ï¼Œä¾›Cè¯­è¨€è°ƒç”¨ã€‚
* æ±‡ç¼–å‡½æ•°è¦éµå®ˆABIï¼Œä¿å­˜å¿…è¦å¯„å­˜å™¨ã€‚
* åœ¨Cä¸­å£°æ˜æ±‡ç¼–å‡½æ•°åŸå‹ï¼ˆ`extern`ï¼‰å³å¯è°ƒç”¨ã€‚

ç¤ºä¾‹æ±‡ç¼–å‡½æ•°ï¼š

```asm
    .global my_asm_func
my_asm_func:
    add a0, a0, a1
    ret
```

å¯¹åº”Cå£°æ˜ï¼š

```c
extern int my_asm_func(int x, int y);
```

è°ƒç”¨ï¼š

```c
int result = my_asm_func(3, 4);
```

### 3. æ±‡ç¼–è®¿é—®Cå˜é‡

* ä½¿ç”¨`extern`å£°æ˜å˜é‡ã€‚
* åœ¨æ±‡ç¼–ä¸­ç”¨ç¬¦å·åè®¿é—®å˜é‡åœ°å€ï¼ŒåŠ è½½/å­˜å‚¨æ•°æ®ã€‚

ç¤ºä¾‹ï¼š

```c
int global_var = 100;
```

æ±‡ç¼–ï¼š

```asm
    .extern global_var
    la t0, global_var
    lw a0, 0(t0)
```

---

### 8.4 æ±‡ç¼–ä¼ªæŒ‡ä»¤å’Œç¼–è¯‘å™¨æŒ‡ç¤º

* `.global`ï¼šå£°æ˜å…¨å±€ç¬¦å·ï¼Œå¯¹é“¾æ¥å™¨å¯è§ã€‚
* `.extern`ï¼šå£°æ˜å¤–éƒ¨ç¬¦å·ï¼Œå¼•ç”¨Cå‡½æ•°æˆ–å˜é‡ã€‚
* `.text`ï¼šä»£ç æ®µã€‚
* `.data`ï¼šæ•°æ®æ®µã€‚
* `.align`ï¼šå¯¹é½ã€‚
* `.globl`ç­‰ä»·äº`.global`ã€‚

---

### 8.5 å‡½æ•°è°ƒç”¨æ ˆç®¡ç†

* æ±‡ç¼–ä¸­å¦‚æœå‡½æ•°è°ƒç”¨å…¶ä»–å‡½æ•°ï¼Œè¦ä¿å­˜`ra`ï¼ˆè¿”å›åœ°å€ï¼‰å’Œéœ€è¦ä¿æŠ¤çš„`s`å¯„å­˜å™¨åˆ°æ ˆã€‚
* æ ˆé¡¶å¿…é¡»ä¿æŒ16å­—èŠ‚å¯¹é½ã€‚

ç¤ºä¾‹ï¼š

```asm
my_func:
    addi sp, sp, -16    # åˆ†é…æ ˆç©ºé—´
    sw ra, 12(sp)       # ä¿å­˜è¿”å›åœ°å€
    sw s0, 8(sp)        # ä¿å­˜ä¿å­˜å¯„å­˜å™¨
    mv s0, sp           # å»ºç«‹å¸§æŒ‡é’ˆ

    # å‡½æ•°ä½“ä»£ç ...

    lw ra, 12(sp)       # æ¢å¤è¿”å›åœ°å€
    lw s0, 8(sp)        # æ¢å¤ä¿å­˜å¯„å­˜å™¨
    addi sp, sp, 16     # é‡Šæ”¾æ ˆç©ºé—´
    ret
```

---

### 8.6 è”åˆç¼–è¯‘ç¤ºä¾‹å‘½ä»¤

* æ±‡ç¼–æ–‡ä»¶ï¼š`file.S` ï¼ˆå¤§å†™Sè¡¨ç¤ºæ±‡ç¼–å™¨éœ€è¦é¢„å¤„ç†ï¼‰
* æ±‡ç¼–ç¼–è¯‘ï¼š`riscv64-unknown-elf-gcc -c file.S -o file.o`
* Cæ–‡ä»¶ç¼–è¯‘ï¼š`riscv64-unknown-elf-gcc -c file.c -o file.o`
* é“¾æ¥ï¼š`riscv64-unknown-elf-gcc file.o file_c.o -o final.elf`

---

### 8.7 æ³¨æ„äº‹é¡¹

* æ±‡ç¼–ç¬¦å·å‘½åéœ€ä¸Cå‡½æ•°/å˜é‡ä¸€è‡´ã€‚
* æ±‡ç¼–ä»£ç éœ€éµå®ˆRISC-V ABIï¼Œé¿å…ç ´åè°ƒç”¨çº¦å®šã€‚
* è°ƒè¯•æ—¶ä½¿ç”¨`-g`é€‰é¡¹ç”Ÿæˆè°ƒè¯•ä¿¡æ¯ï¼Œæ–¹ä¾¿GDBè°ƒè¯•ã€‚
* åŒºåˆ†ä¼ªæŒ‡ä»¤å’ŒçœŸå®æŒ‡ä»¤ï¼Œä¼ªæŒ‡ä»¤è¾…åŠ©æ±‡ç¼–è¿‡ç¨‹ã€‚
* ä½¿ç”¨`.option norelax`é˜²æ­¢ç¬¦å·åœ°å€è¢«relaxä¼˜åŒ–ï¼Œä¾¿äºé“¾æ¥ã€‚

---

### 8.8 æ€»ç»“

| å†…å®¹      | è¯´æ˜                          |
| ------- | --------------------------- |
| è”åˆç¼–è¯‘æ„ä¹‰  | Cå’Œæ±‡ç¼–ä»£ç ååŒå®Œæˆï¼Œå…¼é¡¾æ€§èƒ½å’Œåº•å±‚æ§åˆ¶        |
| è°ƒç”¨çº¦å®š    | å‚æ•°å’Œè¿”å›å€¼å¯„å­˜å™¨ã€æ ˆçš„ä½¿ç”¨è§„åˆ™            |
| ç¬¦å·å£°æ˜    | `.global`ã€`.extern`ä¿è¯ç¬¦å·æ­£ç¡®é“¾æ¥ |
| æ ˆç®¡ç†     | ä¿å­˜å¿…è¦å¯„å­˜å™¨ï¼Œä¿è¯å‡½æ•°è°ƒç”¨å®‰å…¨            |
| æ±‡ç¼–è°ƒç”¨Cå‡½æ•° | æŒ‰çº¦å®šä¼ å‚ï¼Œä½¿ç”¨`call`è°ƒç”¨            |
| Cè°ƒç”¨æ±‡ç¼–å‡½æ•° | æ±‡ç¼–å‡½æ•°å¯¼å‡ºç¬¦å·ï¼ŒCå£°æ˜`extern`        |
| æ±‡ç¼–è®¿é—®Cå˜é‡ | é€šè¿‡ç¬¦å·åŠ è½½åœ°å€è®¿é—®                  |
| ç¼–è¯‘æŒ‡ä»¤    | gccæ±‡ç¼–ç¼–è¯‘ã€é“¾æ¥å‘½ä»¤åŠå‚æ•°             |





